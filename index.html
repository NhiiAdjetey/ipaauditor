<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPA Auditor - iOS Security Analysis Tool</title>
    <meta name="description" content="Professional iOS security auditing platform. Analyze IPA files entirely in your browser.">
    <meta name="author" content="Sandeep Wawdane">
    <meta name="theme-color" content="#030306">

    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <link rel="canonical" href="https://ipaauditor.com/">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <script src="lib/jszip.min.js" integrity="sha384-+mbV2IY1Zk/X1p/nWllGySJSUN8uMs+gUAN10Or95UBH0fpj6GfKgPmgC5EXieXG" crossorigin="anonymous"></script>
    <script src="lib/plist.min.js" integrity="sha384-jkPATc847UB94XOLS2IJZJ3cjGx5UCYAsDT9TpxiKLe0wobpsHj58SU7gTAYP6Lh" crossorigin="anonymous"></script>
    <script src="lib/jspdf.umd.min.js" integrity="sha384-O5lMb4MDjtn5zz9DSqizqf3JK5ne6jnTbRh523aaJiE4fpejSlmaEaksvdfbbCiC" crossorigin="anonymous"></script>
    <style>
        :root {
            --bg-primary: #030306;
            --bg-secondary: #08080c;
            --bg-tertiary: #0c0c12;
            --bg-card: #0e0e14;
            --bg-elevated: #121218;
            --border-subtle: rgba(255, 255, 255, 0.04);
            --border-default: rgba(255, 255, 255, 0.08);
            --border-hover: rgba(255, 255, 255, 0.12);
            --text-primary: #f4f4f6;
            --text-secondary: #a1a1aa;
            --text-muted: #52525b;
            --accent-primary: #818cf8;
            --accent-secondary: #6366f1;
            --accent-glow: rgba(129, 140, 248, 0.4);
            --accent-subtle: rgba(129, 140, 248, 0.08);
            --cyan: #22d3ee;
            --green: #34d399;
            --red: #fb7185;
            --orange: #fb923c;
            --code-bg: #0a0a0e;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 15px; scroll-behavior: smooth; }
        body {
            font-family: 'Outfit', -apple-system, system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }
        .particle-field { position: fixed; inset: 0; z-index: 0; overflow: hidden; pointer-events: none; }
        .particle {
            position: absolute; width: 2px; height: 2px; background: var(--accent-primary);
            border-radius: 50%; opacity: 0; animation: particleFloat 15s infinite;
        }
        .particle::after { content: ''; position: absolute; inset: -2px; background: inherit; border-radius: 50%; filter: blur(4px); opacity: 0.5; }
        @keyframes particleFloat { 0% { opacity: 0; transform: translateY(100vh) scale(0); } 10% { opacity: 0.6; } 90% { opacity: 0.6; } 100% { opacity: 0; transform: translateY(-100vh) scale(1); } }
        .gradient-orbs { position: fixed; inset: 0; z-index: 0; pointer-events: none; overflow: hidden; }
        .orb { position: absolute; border-radius: 50%; filter: blur(100px); opacity: 0.15; }
        .orb-1 { width: 600px; height: 600px; background: linear-gradient(135deg, #6366f1, #8b5cf6); top: -300px; left: -200px; animation: orbDrift1 30s ease-in-out infinite; }
        .orb-2 { width: 500px; height: 500px; background: linear-gradient(135deg, #06b6d4, #22d3ee); bottom: -200px; right: -150px; animation: orbDrift2 25s ease-in-out infinite; }
        .orb-3 { width: 400px; height: 400px; background: linear-gradient(135deg, #8b5cf6, #a855f7); top: 40%; left: 30%; animation: orbDrift3 35s ease-in-out infinite; }
        @keyframes orbDrift1 { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(80px, 40px); } }
        @keyframes orbDrift2 { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(-60px, -60px); } }
        @keyframes orbDrift3 { 0%, 100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.1; } 50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.2; } }
        .grid-pattern {
            position: fixed; inset: 0; z-index: 0; pointer-events: none;
            background-image: linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 60px 60px; mask-image: radial-gradient(ellipse at center, black 0%, transparent 70%);
        }
        .header { position: fixed; top: 0; left: 0; right: 0; z-index: 100; padding: 16px 24px; background: rgba(3, 3, 6, 0.8); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border-subtle); }
        .header-inner { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; gap: 16px; }
        .logo { display: flex; align-items: center; gap: 12px; text-decoration: none; color: inherit; }
        .logo-icon { width: 36px; height: 36px; }
        .logo-icon svg { width: 100%; height: 100%; }
        .logo-text { font-weight: 700; font-size: 18px; letter-spacing: -0.5px; }
        .logo-text span { color: var(--accent-primary); }
        .nav-links { display: flex; align-items: center; gap: 8px; }
        .nav-link { padding: 8px 16px; font-size: 14px; font-weight: 500; color: var(--text-secondary); text-decoration: none; border-radius: 8px; transition: all 0.2s ease; }
        .nav-link:hover { color: var(--text-primary); background: var(--accent-subtle); }
        .btn { padding: 10px 20px; font-size: 14px; font-weight: 600; font-family: inherit; border: none; border-radius: 10px; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; }
        .btn-primary { background: linear-gradient(135deg, var(--accent-secondary), var(--accent-primary)); color: white; box-shadow: 0 4px 20px var(--accent-glow); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 30px var(--accent-glow); }
        .btn-ghost { background: var(--bg-elevated); color: var(--text-primary); border: 1px solid var(--border-default); }
        .btn-ghost:hover { background: var(--bg-card); border-color: var(--border-hover); }
        .btn svg { width: 16px; height: 16px; }
        .hero { position: relative; z-index: 2; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 120px 24px 80px; text-align: center; }
        .hero-badge { display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: var(--accent-subtle); border: 1px solid rgba(129, 140, 248, 0.2); border-radius: 100px; font-size: 13px; font-weight: 600; color: var(--accent-primary); margin-bottom: 32px; animation: fadeUp 0.8s ease forwards; }
        .hero-badge::before { content: ''; width: 6px; height: 6px; background: var(--accent-primary); border-radius: 50%; animation: pulse 2s ease infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.5); } }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .hero-title { font-size: clamp(40px, 7vw, 72px); font-weight: 800; letter-spacing: -2px; line-height: 1.1; margin-bottom: 24px; animation: fadeUp 0.8s ease 0.1s forwards; opacity: 0; }
        .hero-title .gradient { background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-primary) 50%, var(--cyan) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .hero-subtitle { font-size: 18px; color: var(--text-secondary); max-width: 560px; margin: 0 auto 40px; line-height: 1.7; animation: fadeUp 0.8s ease 0.2s forwards; opacity: 0; }
        .hero-actions { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; animation: fadeUp 0.8s ease 0.3s forwards; opacity: 0; }
        .hero-stats { display: flex; align-items: center; justify-content: center; gap: 40px; margin-top: 60px; padding-top: 40px; border-top: 1px solid var(--border-subtle); animation: fadeUp 0.8s ease 0.4s forwards; opacity: 0; }
        .hero-stat { text-align: center; }
        .hero-stat-value { font-size: 28px; font-weight: 700; color: var(--text-primary); }
        .hero-stat-label { font-size: 13px; color: var(--text-muted); margin-top: 4px; }
        .dropzone { position: relative; max-width: 600px; margin: 48px auto 0; padding: 56px 48px; background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-tertiary) 100%); border: 2px solid var(--border-default); border-radius: 24px; cursor: pointer; transition: all 0.3s ease; animation: fadeUp 0.8s ease 0.5s forwards; opacity: 0; overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        .dropzone::before { content: ''; position: absolute; inset: 0; background: radial-gradient(ellipse at center, var(--accent-subtle) 0%, transparent 70%); opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .dropzone::after { content: ''; position: absolute; inset: 0; border-radius: 24px; background: linear-gradient(135deg, rgba(129, 140, 248, 0.1) 0%, rgba(34, 211, 238, 0.05) 100%); opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .dropzone:hover { border-color: var(--accent-primary); transform: translateY(-4px); box-shadow: 0 16px 48px rgba(129, 140, 248, 0.2); }
        .dropzone:hover::before, .dropzone:hover::after { opacity: 1; }
        .dropzone.drag-over { border-color: var(--cyan); background: linear-gradient(135deg, rgba(34, 211, 238, 0.1) 0%, var(--bg-tertiary) 100%); transform: scale(1.02); box-shadow: 0 20px 60px rgba(34, 211, 238, 0.25); }
        .dropzone-icon { width: 80px; height: 80px; margin: 0 auto 28px; position: relative; z-index: 1; filter: drop-shadow(0 4px 12px rgba(129, 140, 248, 0.3)); }
        .dropzone-icon svg { width: 100%; height: 100%; }
        .dropzone-title { font-size: 24px; font-weight: 700; margin-bottom: 10px; position: relative; z-index: 1; background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-primary) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .dropzone-desc { color: var(--text-muted); font-size: 15px; margin-bottom: 28px; position: relative; z-index: 1; }
        .dropzone-formats { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; position: relative; z-index: 1; }
        .format-tag { padding: 8px 16px; background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: 8px; font-size: 12px; font-family: 'JetBrains Mono', monospace; color: var(--text-secondary); display: flex; align-items: center; transition: all 0.2s ease; }
        .format-tag:hover { border-color: var(--accent-primary); color: var(--accent-primary); }
        .file-input { display: none; }
        .features-section { position: relative; z-index: 2; padding: 100px 24px; }
        .section-header { text-align: center; max-width: 560px; margin: 0 auto 60px; }
        .section-label { display: inline-block; padding: 6px 14px; background: var(--accent-subtle); border-radius: 6px; font-size: 12px; font-weight: 600; color: var(--accent-primary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; }
        .section-title { font-size: clamp(28px, 5vw, 42px); font-weight: 800; letter-spacing: -1px; margin-bottom: 16px; }
        .section-desc { font-size: 16px; color: var(--text-secondary); line-height: 1.7; }
        .features-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; max-width: 1100px; margin: 0 auto; }
        .feature-card { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 16px; padding: 28px; transition: all 0.3s ease; }
        .feature-card:hover { border-color: var(--border-hover); transform: translateY(-4px); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); }
        .feature-icon { width: 44px; height: 44px; background: var(--accent-subtle); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; }
        .feature-icon svg { width: 22px; height: 22px; stroke: var(--accent-primary); }
        .feature-title { font-size: 17px; font-weight: 700; margin-bottom: 8px; }
        .feature-desc { font-size: 14px; color: var(--text-secondary); line-height: 1.6; }
        .privacy-section { position: relative; z-index: 2; padding: 80px 24px; }
        .privacy-card { max-width: 700px; margin: 0 auto; background: linear-gradient(135deg, rgba(52, 211, 153, 0.08) 0%, rgba(34, 211, 238, 0.04) 100%); border: 1px solid rgba(52, 211, 153, 0.15); border-radius: 20px; padding: 48px; text-align: center; }
        .privacy-icon { width: 56px; height: 56px; background: rgba(52, 211, 153, 0.1); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; }
        .privacy-icon svg { width: 28px; height: 28px; stroke: var(--green); }
        .privacy-title { font-size: 24px; font-weight: 700; margin-bottom: 12px; }
        .privacy-desc { font-size: 15px; color: var(--text-secondary); line-height: 1.7; max-width: 500px; margin: 0 auto 28px; }
        .privacy-badges { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; }
        .privacy-badge { display: flex; align-items: center; gap: 8px; padding: 10px 16px; background: var(--bg-elevated); border: 1px solid var(--border-default); border-radius: 100px; font-size: 13px; font-weight: 500; }
        .privacy-badge svg { width: 14px; height: 14px; stroke: var(--green); }
        .footer { position: relative; z-index: 2; padding: 40px 24px; border-top: 1px solid var(--border-subtle); background: var(--bg-secondary); }
        .footer-inner { max-width: 1100px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px; }
        .footer-brand { display: flex; align-items: center; gap: 16px; }
        .footer-logo { display: flex; align-items: center; gap: 10px; text-decoration: none; color: inherit; }
        .footer-logo svg { width: 24px; height: 24px; }
        .footer-logo span { font-weight: 600; font-size: 14px; }
        .footer-divider { color: var(--text-muted); font-size: 14px; }
        .footer-github { display: flex; align-items: center; gap: 8px; padding: 8px 14px; background: var(--bg-elevated); border: 1px solid var(--border-default); border-radius: 8px; font-size: 13px; font-weight: 500; color: var(--text-secondary); text-decoration: none; transition: all 0.2s ease; }
        .footer-github:hover { color: var(--text-primary); background: var(--accent-subtle); border-color: var(--accent-primary); transform: translateY(-1px); }
        .footer-github svg { flex-shrink: 0; }
        .footer-copyright { font-size: 13px; color: var(--text-muted); }
        .footer-copyright a { color: var(--accent-primary); text-decoration: none; font-weight: 500; }
        .footer-copyright a:hover { text-decoration: underline; }

        /* App Container */
        .app-container { display: none; position: relative; z-index: 2; max-width: 1300px; margin: 0 auto; padding: 90px 24px 40px; }
        .app-container.active { display: block; }
        .app-header { display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid var(--border-subtle); flex-wrap: wrap; }
        .app-title { display: flex; align-items: center; gap: 16px; }
        .app-icon { width: 48px; height: 48px; background: linear-gradient(135deg, var(--accent-secondary), var(--accent-primary)); border-radius: 14px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .app-icon svg { width: 24px; height: 24px; stroke: white; }
        .app-icon img { width: 100%; height: 100%; object-fit: cover; }
        .app-info h2 { font-size: 20px; font-weight: 700; margin-bottom: 2px; }
        .app-info p { font-size: 13px; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }
        .app-actions { display: flex; gap: 10px; flex-wrap: wrap; }

        /* Findings Vertical */
        .findings-vertical { display: flex; flex-direction: column; gap: 8px; margin-top: 8px; }
        .finding-row { display: flex; align-items: center; gap: 10px; padding: 8px 12px; border-radius: 8px; background: var(--bg-secondary); }
        .finding-row .count { font-size: 20px; font-weight: 700; min-width: 30px; }
        .finding-row .label { font-size: 13px; color: var(--text-secondary); }
        .finding-row.high { background: rgba(251, 113, 133, 0.1); }
        .finding-row.high .count { color: var(--red); }
        .finding-row.warning { background: rgba(251, 146, 60, 0.1); }
        .finding-row.warning .count { color: var(--orange); }
        .finding-row.info { background: rgba(34, 211, 238, 0.1); }
        .finding-row.info .count { color: var(--cyan); }
        .finding-row.secure { background: rgba(52, 211, 153, 0.1); }
        .finding-row.secure .count { color: var(--green); }
        .score-value { position: relative; z-index: 1; }
        .score-stats { display: flex; gap: 24px; flex-wrap: wrap; }
        .score-stat { text-align: center; min-width: 70px; }
        .score-stat-value { font-size: 24px; font-weight: 700; }
        .score-stat-value.high { color: var(--red); }
        .score-stat-value.warning { color: var(--orange); }
        .score-stat-value.info { color: var(--cyan); }
        .score-stat-value.secure { color: var(--green); }
        .score-stat-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; margin-top: 4px; }

        /* Tabs */
        .tabs { display: flex; gap: 4px; margin-bottom: 24px; padding: 4px; background: var(--bg-secondary); border-radius: 12px; overflow-x: auto; }
        .tab { padding: 10px 18px; font-size: 13px; font-weight: 500; font-family: inherit; color: var(--text-muted); background: transparent; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px; white-space: nowrap; }
        .tab:hover { color: var(--text-secondary); background: var(--bg-tertiary); }
        .tab.active { color: var(--text-primary); background: var(--bg-elevated); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); }
        .tab svg { width: 16px; height: 16px; }
        .tab-badge { padding: 2px 8px; background: var(--red); color: white; font-size: 10px; font-weight: 700; border-radius: 100px; }
        .panel { display: none; }
        .panel.active { display: block; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 24px; }
        .stats-grid .findings-card { grid-row: span 2; display: flex; flex-direction: column; justify-content: center; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 14px; padding: 20px; }
        .stat-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .stat-card-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-card-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .stat-card-icon svg { width: 16px; height: 16px; }
        .stat-card-icon.accent { background: var(--accent-subtle); }
        .stat-card-icon.accent svg { stroke: var(--accent-primary); }
        .stat-card-icon.red { background: rgba(251, 113, 133, 0.1); }
        .stat-card-icon.red svg { stroke: var(--red); }
        .stat-card-icon.cyan { background: rgba(34, 211, 238, 0.1); }
        .stat-card-icon.cyan svg { stroke: var(--cyan); }
        .stat-card-icon.green { background: rgba(52, 211, 153, 0.1); }
        .stat-card-icon.green svg { stroke: var(--green); }
        .stat-card-icon.orange { background: rgba(251, 146, 60, 0.1); }
        .stat-card-icon.orange svg { stroke: var(--orange); }
        .stat-card-value { font-size: 28px; font-weight: 700; margin-bottom: 4px; }
        .stat-card-desc { font-size: 13px; color: var(--text-muted); }

        /* Results Section */
        .results-section { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 14px; overflow: hidden; margin-bottom: 20px; }
        .results-header { padding: 16px 20px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-subtle); display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 600; }
        .results-header svg { width: 18px; height: 18px; stroke: var(--accent-primary); }

        /* Finding Cards */
        .finding-card { background: var(--bg-tertiary); border: 1px solid var(--border-subtle); border-radius: 12px; margin-bottom: 12px; overflow: hidden; border-left: 4px solid var(--border-default); }
        .finding-card.high { border-left-color: var(--red); }
        .finding-card.warning { border-left-color: var(--orange); }
        .finding-card.info { border-left-color: var(--cyan); }
        .finding-card.secure { border-left-color: var(--green); }
        .finding-header { display: flex; align-items: center; gap: 12px; padding: 16px 20px; cursor: pointer; transition: background 0.2s; }
        .finding-header:hover { background: rgba(255, 255, 255, 0.02); }
        .severity-badge { padding: 4px 12px; border-radius: 100px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; flex-shrink: 0; }
        .severity-badge.high { background: rgba(251, 113, 133, 0.15); color: var(--red); }
        .severity-badge.warning { background: rgba(251, 146, 60, 0.15); color: var(--orange); }
        .severity-badge.info { background: rgba(34, 211, 238, 0.15); color: var(--cyan); }
        .severity-badge.secure { background: rgba(52, 211, 153, 0.15); color: var(--green); }
        .finding-title { flex: 1; font-weight: 600; font-size: 14px; }
        .instance-count { background: rgba(255, 255, 255, 0.08); padding: 4px 10px; border-radius: 100px; font-size: 11px; color: var(--text-secondary); }
        .finding-toggle { color: var(--text-muted); transition: transform 0.3s; font-size: 12px; }
        .finding-body { display: none; padding: 0 20px 20px; border-top: 1px solid var(--border-subtle); }
        .finding-body.expanded { display: block; }
        .finding-description { padding: 16px 0; color: var(--text-secondary); line-height: 1.7; font-size: 13px; }
        .finding-meta { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
        .meta-tag { background: var(--accent-subtle); color: var(--accent-primary); padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; font-family: 'JetBrains Mono', monospace; }
        .instances-section { margin-top: 16px; }
        .instances-header { font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
        .instance-item { background: var(--code-bg); border: 1px solid var(--border-subtle); border-radius: 10px; padding: 14px 16px; margin-bottom: 10px; transition: all 0.2s; }
        .instance-item:hover { border-color: var(--border-hover); background: rgba(129, 140, 248, 0.03); }
        .instance-item:last-child { margin-bottom: 0; }
        .instance-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .instance-number { background: var(--accent-primary); color: white; padding: 2px 8px; border-radius: 100px; font-size: 10px; font-weight: 700; }
        .instance-file { color: var(--cyan); font-family: 'JetBrains Mono', monospace; font-size: 12px; }
        .instance-file.clickable { cursor: pointer; transition: all 0.2s ease; padding: 2px 6px; border-radius: 4px; }
        .instance-file.clickable:hover { text-decoration: underline; background: rgba(34, 211, 238, 0.1); }
        .instance-offset { color: var(--orange); font-size: 11px; font-family: 'JetBrains Mono', monospace; background: rgba(251, 146, 60, 0.1); padding: 2px 6px; border-radius: 4px; }
        .instance-match { margin-bottom: 10px; }
        .instance-match code { background: rgba(251, 146, 60, 0.15); color: var(--orange); padding: 3px 8px; border-radius: 4px; font-size: 12px; font-family: 'JetBrains Mono', monospace; word-break: break-all; }
        .instance-snippet { background: rgba(0, 0, 0, 0.3); padding: 12px; border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 11px; line-height: 1.7; overflow-x: auto; white-space: pre-wrap; word-break: break-word; color: var(--text-secondary); margin: 0; }

        /* Binary Analysis */
        .checksec-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
        .checksec-item { display: flex; align-items: center; gap: 12px; padding: 14px 16px; background: var(--bg-tertiary); border-radius: 10px; border-left: 3px solid var(--border-default); }
        .checksec-item.pass { border-left-color: var(--green); }
        .checksec-item.fail { border-left-color: var(--red); }
        .checksec-status { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .checksec-item.pass .checksec-status { background: rgba(52, 211, 153, 0.15); color: var(--green); }
        .checksec-item.fail .checksec-status { background: rgba(251, 113, 133, 0.15); color: var(--red); }
        .checksec-info { flex: 1; }
        .checksec-name { font-weight: 600; font-size: 13px; margin-bottom: 2px; }
        .checksec-desc { font-size: 11px; color: var(--text-muted); }
        .library-item { padding: 8px 12px; border-bottom: 1px solid var(--border-subtle); font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--text-secondary); }
        .library-item:last-child { border-bottom: none; }

        /* File Explorer - IMPROVED UX */
        .explorer-container { display: grid; grid-template-columns: 300px 1fr; gap: 12px; height: 650px; max-height: 75vh; }
        .explorer-sidebar { background: var(--bg-tertiary); border: 1px solid var(--border-subtle); border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; height: 100%; }

        /* Quick Access - Clean Design */
        .quick-access { border-bottom: 1px solid var(--border-subtle); flex-shrink: 0; }
        .quick-access-header { display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary)); font-size: 10px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .quick-access-toggle { cursor: pointer; font-size: 12px; color: var(--text-muted); width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; border-radius: 3px; }
        .quick-access-toggle:hover { background: var(--bg-card); color: var(--text-primary); }
        .quick-access-list { padding: 8px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; }
        .quick-access.collapsed .quick-access-list { display: none; }
        .qa-empty { color: var(--text-muted); font-size: 10px; text-align: center; padding: 8px; grid-column: 1 / -1; }
        .quick-access-item { display: flex; align-items: center; gap: 8px; padding: 8px 10px; background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 6px; cursor: pointer; transition: all 0.15s; }
        .quick-access-item:hover { background: var(--accent-subtle); border-color: var(--cyan); transform: translateY(-1px); }
        .quick-access-item .qa-icon { font-size: 16px; flex-shrink: 0; }
        .quick-access-item .qa-text { display: flex; flex-direction: column; min-width: 0; }
        .quick-access-item .qa-name { font-size: 11px; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .quick-access-item .qa-desc { font-size: 9px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .quick-access-item:hover .qa-name { color: var(--cyan); }

        /* Explorer Controls */
        .explorer-controls { padding: 8px; border-bottom: 1px solid var(--border-subtle); display: flex; gap: 6px; flex-shrink: 0; flex-wrap: wrap; }
        .explorer-controls input { flex: 1; min-width: 120px; padding: 6px 10px; background: var(--bg-card); border: 1px solid var(--border-default); border-radius: 5px; color: var(--text-primary); font-size: 11px; }
        .explorer-controls input:focus { outline: none; border-color: var(--accent-primary); }
        .explorer-controls select { padding: 6px 8px; background: var(--bg-card); border: 1px solid var(--border-default); border-radius: 5px; color: var(--text-secondary); font-size: 10px; cursor: pointer; }
        .explorer-controls select:focus { outline: none; border-color: var(--accent-primary); }
        .tree-controls { display: flex; gap: 4px; }
        .tree-controls button { padding: 5px 10px; background: var(--bg-card); border: 1px solid var(--border-default); border-radius: 5px; color: var(--text-muted); cursor: pointer; font-size: 11px; transition: all 0.15s; font-weight: 500; }
        .tree-controls button:hover { background: var(--accent-subtle); color: var(--cyan); border-color: var(--cyan); }

        #fileSearchResults { max-height: 120px; overflow-y: auto; flex-shrink: 0; border-bottom: 1px solid var(--border-subtle); }
        .search-result-item { padding: 6px 10px; cursor: pointer; font-family: 'JetBrains Mono', monospace; font-size: 10px; border-bottom: 1px solid var(--border-subtle); color: var(--text-secondary); transition: all 0.1s; }
        .search-result-item:hover { background: var(--accent-subtle); color: var(--cyan); }
        .search-result-item:last-child { border-bottom: none; }

        /* File Tree Section Header */
        .tree-section-header { display: flex; justify-content: space-between; align-items: center; padding: 6px 12px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-subtle); font-size: 10px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .tree-file-count { font-size: 10px; color: var(--cyan); background: var(--accent-subtle); padding: 2px 8px; border-radius: 10px; }

        /* File Tree - Improved Layout */
        .file-tree-container { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 8px; font-size: 12px; min-height: 0; }
        .tree-folder { display: block; }
        .tree-folder-header { display: flex; align-items: center; gap: 6px; padding: 4px 8px; cursor: pointer; border-radius: 5px; font-size: 12px; font-weight: 500; transition: all 0.1s; color: var(--text-primary); }
        .tree-folder-header:hover { background: rgba(255, 255, 255, 0.05); }
        .tree-folder-content { display: none; padding-left: 18px; margin-left: 8px; border-left: 1px solid var(--border-subtle); }
        .tree-folder.open > .tree-folder-content { display: block; }
        .tree-folder.open > .tree-folder-header { color: var(--cyan); }
        .tree-folder.open > .tree-folder-header .folder-chevron { transform: rotate(90deg); }
        .tree-folder.filtered { display: none; }
        .tree-folder.has-match { display: block; }
        .tree-folder.has-match > .tree-folder-content { display: block; }
        .folder-chevron { font-size: 10px; color: var(--text-muted); transition: transform 0.15s; width: 12px; flex-shrink: 0; }
        .folder-icon { font-size: 14px; flex-shrink: 0; }
        .folder-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }
        .folder-count { font-size: 10px; color: var(--text-muted); margin-left: 6px; background: var(--bg-card); padding: 1px 6px; border-radius: 10px; }
        .tree-file { display: flex; align-items: center; gap: 6px; padding: 4px 8px; cursor: pointer; border-radius: 5px; font-size: 11px; color: var(--text-secondary); transition: all 0.1s; }
        .tree-file:hover { background: var(--accent-subtle); color: var(--text-primary); }
        .tree-file.active { background: var(--accent-subtle); color: var(--cyan); box-shadow: inset 3px 0 0 var(--cyan); font-weight: 500; }
        .tree-file.filtered { display: none; }
        .tree-file.match { display: flex; }
        .tree-file.important { background: rgba(251, 146, 60, 0.08); border-left: 2px solid var(--orange); }
        .tree-file.important:hover { background: rgba(251, 146, 60, 0.15); }
        .tree-file.important .file-name { color: var(--text-primary); font-weight: 500; }
        .file-icon { font-size: 13px; flex-shrink: 0; }
        .file-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Explorer Main */
        .explorer-main { background: var(--bg-tertiary); border: 1px solid var(--border-subtle); border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; height: 100%; }
        .breadcrumb-bar { padding: 8px 12px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-subtle); display: flex; align-items: center; gap: 4px; flex-wrap: wrap; flex-shrink: 0; font-size: 11px; }
        .breadcrumb-item { color: var(--text-muted); cursor: pointer; padding: 2px 6px; border-radius: 3px; transition: all 0.1s; }
        .breadcrumb-item:hover { background: var(--accent-subtle); color: var(--cyan); }
        .breadcrumb-sep { color: var(--text-muted); }
        .explorer-toolbar { padding: 8px 12px; background: var(--bg-card); border-bottom: 1px solid var(--border-subtle); display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
        .current-file-path { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--cyan); flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .viewer-actions { display: flex; gap: 6px; }
        .viewer-btn { padding: 5px 10px; background: var(--bg-card); border: 1px solid var(--border-default); border-radius: 5px; color: var(--text-muted); cursor: pointer; font-size: 11px; transition: all 0.15s; font-weight: 500; }
        .viewer-btn:hover { background: var(--accent-subtle); color: var(--cyan); border-color: var(--cyan); }
        .file-viewer-container { flex: 1; overflow: hidden; min-height: 0; display: flex; flex-direction: column; }
        #fileViewer { flex: 1; display: flex; flex-direction: column; min-height: 0; overflow: hidden; }
        #fileViewer > .hex-viewer { flex: 1; display: flex; flex-direction: column; min-height: 0; overflow: hidden; }
        #fileViewer > .code-viewer { padding: 16px; overflow: auto; flex: 1; }
        #fileViewer > .image-viewer { padding: 16px; overflow: auto; flex: 1; }
        #fileViewer > .no-data { padding: 40px; text-align: center; }
        .code-viewer { font-family: 'JetBrains Mono', monospace; font-size: 12px; line-height: 1.8; }
        .code-line { display: flex; }
        .code-line:hover { background: rgba(255, 255, 255, 0.02); }
        .line-num { width: 50px; text-align: right; padding-right: 16px; color: var(--text-muted); user-select: none; flex-shrink: 0; border-right: 1px solid var(--border-subtle); margin-right: 16px; }
        .line-content { white-space: pre-wrap; word-break: break-all; flex: 1; }
        .highlight-line { background: rgba(251, 146, 60, 0.15) !important; }
        .highlight-line .line-num { color: var(--orange); }

        /* Hex Viewer - Professional Layout */
        .hex-viewer { font-family: 'JetBrains Mono', monospace; }
        .hex-header { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-subtle); flex-wrap: wrap; }
        .hex-info-badge { padding: 4px 10px; background: var(--accent-subtle); color: var(--accent-primary); border-radius: 6px; font-size: 11px; font-weight: 600; }
        .hex-info-badge.format { background: linear-gradient(135deg, var(--accent-subtle), rgba(34, 211, 238, 0.1)); }
        .hex-controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; padding: 10px 16px; border-bottom: 1px solid var(--border-subtle); background: var(--bg-tertiary); }
        .hex-nav-btn { padding: 6px 12px; background: var(--bg-elevated); border: 1px solid var(--border-default); border-radius: 6px; color: var(--text-secondary); font-size: 11px; cursor: pointer; font-family: inherit; transition: all 0.15s; font-weight: 500; }
        .hex-nav-btn:hover:not(:disabled) { background: var(--accent-subtle); color: var(--cyan); border-color: var(--cyan); }
        .hex-nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .hex-page-info { font-size: 11px; color: var(--text-muted); padding: 0 12px; background: var(--bg-card); border-radius: 4px; padding: 4px 10px; }
        .hex-goto { padding: 6px 12px; background: var(--bg-card); border: 1px solid var(--border-default); border-radius: 6px; color: var(--text-primary); font-size: 11px; font-family: 'JetBrains Mono', monospace; width: 130px; }
        .hex-goto:focus { outline: none; border-color: var(--accent-primary); background: var(--bg-elevated); }
        .hex-search-bar { display: flex; gap: 8px; align-items: center; padding: 10px 16px; border-bottom: 1px solid var(--border-subtle); background: var(--bg-card); }
        .hex-search-input { flex: 1; max-width: 280px; padding: 6px 12px; background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: 6px; color: var(--text-primary); font-size: 11px; font-family: inherit; }
        .hex-search-input:focus { outline: none; border-color: var(--accent-primary); }
        .hex-search-info { font-size: 10px; color: var(--cyan); font-weight: 600; background: var(--accent-subtle); padding: 3px 8px; border-radius: 4px; }
        /* Hex Content - Virtual Scroll Layout */
        .hex-scroll-container { flex: 1; position: relative; overflow-y: auto; overflow-x: hidden; background: var(--code-bg); min-height: 200px; }
        .hex-table-header { display: grid; grid-template-columns: 90px 1fr 170px; padding: 8px 16px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-default); font-size: 10px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; position: sticky; top: 0; z-index: 10; }
        .hex-table-header span:last-child { padding-left: 16px; border-left: 1px solid var(--border-subtle); }
        .hex-virtual-content { position: relative; }
        .hex-lines-container { position: absolute; left: 0; right: 0; }
        .hex-line { display: grid; grid-template-columns: 90px 1fr 170px; font-size: 12px; height: 24px; line-height: 24px; padding: 0 16px; border-bottom: 1px solid rgba(255,255,255,0.02); }
        .hex-line:hover { background: rgba(129, 140, 248, 0.08); }
        .hex-line:nth-child(even) { background: rgba(255, 255, 255, 0.015); }
        .hex-line:nth-child(even):hover { background: rgba(129, 140, 248, 0.08); }
        .hex-offset { color: var(--accent-primary); font-weight: 500; display: flex; align-items: center; font-size: 11px; }
        .hex-bytes { color: var(--text-secondary); display: flex; align-items: center; font-variant-numeric: tabular-nums; gap: 0; }
        .hex-byte { display: inline-block; width: 22px; text-align: center; font-size: 11px; }
        .hex-byte.null { color: var(--text-muted); opacity: 0.4; }
        .hex-byte.printable { color: var(--text-primary); }
        .hex-byte.high { color: var(--orange); }
        .hex-byte-gap { width: 12px; }
        .hex-ascii { color: var(--text-secondary); padding-left: 16px; border-left: 1px solid var(--border-subtle); display: flex; align-items: center; letter-spacing: 0.5px; font-size: 11px; }
        .hex-ascii-char { display: inline-block; width: 9px; text-align: center; }
        .hex-ascii-char.printable { color: var(--cyan); }
        .hex-ascii-char.null { color: var(--text-muted); opacity: 0.3; }
        .hex-ascii-char.control { color: var(--red); opacity: 0.5; }
        .hex-highlight { background: rgba(251, 146, 60, 0.4); color: var(--orange) !important; border-radius: 2px; font-weight: 600; }
        .hex-status-bar { display: flex; justify-content: space-between; align-items: center; padding: 6px 16px; background: var(--bg-secondary); border-top: 1px solid var(--border-subtle); font-size: 10px; color: var(--text-muted); }
        .hex-status-bar .hex-position { font-family: 'JetBrains Mono', monospace; color: var(--cyan); }
        .hex-jump-input { width: 120px; padding: 4px 8px; background: var(--bg-card); border: 1px solid var(--border-default); border-radius: 4px; color: var(--text-primary); font-size: 10px; font-family: 'JetBrains Mono', monospace; }
        .hex-jump-input:focus { outline: none; border-color: var(--accent-primary); }

        /* Strings Viewer */
        .strings-viewer { font-family: 'JetBrains Mono', monospace; }
        .strings-filter-bar { display: flex; gap: 12px; align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--border-subtle); }
        .strings-filter-input { flex: 1; max-width: 400px; padding: 8px 12px; background: var(--bg-card); border: 1px solid var(--border-default); border-radius: 6px; color: var(--text-primary); font-size: 12px; font-family: inherit; }
        .strings-filter-input:focus { outline: none; border-color: var(--accent-primary); }
        .strings-count { font-size: 12px; color: var(--text-muted); }
        .strings-nav { display: flex; gap: 8px; align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--border-subtle); }
        .strings-content { padding: 8px 16px; max-height: 500px; overflow-y: auto; }
        .string-entry { display: flex; align-items: center; gap: 12px; padding: 4px 16px; cursor: pointer; transition: all 0.15s; border-bottom: 1px solid rgba(255,255,255,0.02); }
        .string-entry:hover { background: var(--accent-subtle); }
        .string-entry:nth-child(even) { background: rgba(255,255,255,0.01); }
        .string-entry:nth-child(even):hover { background: var(--accent-subtle); }
        .string-entry.current-match { background: rgba(34, 211, 238, 0.2); border-left: 3px solid var(--cyan); }
        .string-index { color: var(--text-muted); font-size: 10px; width: 45px; flex-shrink: 0; text-align: right; }
        .string-offset { color: var(--accent-primary); font-size: 10px; width: 85px; flex-shrink: 0; font-weight: 500; }
        .string-value { color: var(--text-secondary); font-size: 11px; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Image Viewer */
        .image-viewer { text-align: center; padding: 24px; }
        .image-info { display: flex; gap: 8px; justify-content: center; margin-bottom: 16px; }
        .image-container { max-width: 100%; overflow: auto; background: var(--bg-secondary); border-radius: 12px; padding: 24px; }
        .image-container img { max-width: 100%; height: auto; border-radius: 8px; }

        /* View Mode Tabs */
        .view-mode-tabs { display: flex; gap: 6px; padding: 10px 16px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-subtle); }
        .view-mode-tab { padding: 6px 14px; font-size: 11px; font-weight: 600; font-family: inherit; color: var(--text-muted); background: var(--bg-card); border: 1px solid var(--border-default); border-radius: 5px; cursor: pointer; transition: all 0.15s; }
        .view-mode-tab:hover { color: var(--text-secondary); background: var(--accent-subtle); border-color: var(--cyan); }
        .view-mode-tab.active { color: var(--cyan); background: var(--accent-subtle); border-color: var(--cyan); }

        /* Plist Viewer */
        .plist-viewer { background: var(--code-bg); border-radius: 10px; padding: 20px; max-height: 600px; overflow: auto; }
        .plist-viewer pre { white-space: pre-wrap; word-break: break-word; font-family: 'JetBrains Mono', monospace; font-size: 12px; line-height: 1.7; color: var(--text-secondary); margin: 0; }

        .no-data { text-align: center; padding: 40px; color: var(--text-muted); }
        .no-data svg { width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.4; }

        /* Permissions */
        .permissions-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 12px; }
        .permission-item { background: var(--bg-tertiary); border: 1px solid var(--border-subtle); border-radius: 10px; padding: 16px; }
        .permission-header { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
        .permission-name { font-weight: 600; font-size: 14px; color: var(--text-primary); }
        .permission-key { margin-bottom: 10px; }
        .permission-key code { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--cyan); background: var(--bg-card); padding: 3px 8px; border-radius: 4px; }
        .permission-reason { font-size: 12px; line-height: 1.5; background: var(--bg-card); padding: 10px 12px; border-radius: 6px; border-left: 3px solid var(--orange); }
        .reason-label { display: block; font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .reason-text { color: var(--text-secondary); font-style: italic; }

        /* Loading */
        .loading-overlay { position: fixed; inset: 0; z-index: 1000; background: rgba(3, 3, 6, 0.95); backdrop-filter: blur(20px); display: none; flex-direction: column; align-items: center; justify-content: center; }
        .loading-overlay.active { display: flex; }
        .loader { width: 48px; height: 48px; border: 3px solid var(--bg-elevated); border-top-color: var(--accent-primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 24px; font-size: 16px; font-weight: 600; }
        .loading-subtext { margin-top: 8px; font-size: 13px; color: var(--text-muted); }
        .progress-bar { width: 200px; height: 4px; background: var(--bg-elevated); border-radius: 2px; margin-top: 20px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent-secondary), var(--accent-primary)); transition: width 0.3s ease; }

        /* Toast */
        .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 1001; display: flex; flex-direction: column; gap: 8px; }
        .toast { padding: 14px 20px; background: var(--bg-elevated); border: 1px solid var(--border-default); border-radius: 10px; font-size: 13px; display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s ease; }
        .toast.success { border-color: rgba(52, 211, 153, 0.3); }
        .toast.error { border-color: rgba(251, 113, 133, 0.3); }
        .toast svg { width: 18px; height: 18px; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

        /* Filter bar */
        .filter-bar { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
        .filter-btn { padding: 6px 14px; font-size: 12px; font-weight: 500; font-family: inherit; background: var(--bg-elevated); color: var(--text-secondary); border: 1px solid var(--border-default); border-radius: 6px; cursor: pointer; transition: all 0.2s ease; }
        .filter-btn:hover { border-color: var(--border-hover); color: var(--text-primary); }
        .filter-btn.active { background: var(--accent-subtle); border-color: var(--accent-primary); color: var(--accent-primary); }

        /* Info Grid */
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
        .info-item { background: var(--bg-tertiary); padding: 14px 16px; border-radius: 8px; }
        .info-item label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 6px; }
        .info-item .value { font-size: 13px; font-family: 'JetBrains Mono', monospace; word-break: break-all; color: var(--text-primary); }
        .info-item .value.hash { font-size: 10px; line-height: 1.6; }

        /* Responsive */
        @media (max-width: 900px) {
            .features-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .explorer-container { grid-template-columns: 1fr; height: auto; max-height: none; }
            .explorer-sidebar { height: 250px; }
            .explorer-main { height: 400px; }
        }
        @media (max-width: 600px) {
            .hero-stats { flex-direction: column; gap: 20px; }
            .stats-grid { grid-template-columns: 1fr; }
            .nav-links { display: none; }
            .findings-summary-card { padding: 12px; }
            .findings-stats { gap: 8px; }
            .finding-stat { padding: 12px 16px; min-width: 70px; }
            .finding-stat-value { font-size: 20px; }
        }
    </style>
</head>
<body>
    <div class="particle-field" id="particleField"></div>
    <div class="gradient-orbs"><div class="orb orb-1"></div><div class="orb orb-2"></div><div class="orb orb-3"></div></div>
    <div class="grid-pattern"></div>

    <header class="header">
        <div class="header-inner">
            <a href="#" class="logo" onclick="location.reload()">
                <div class="logo-icon"><svg viewBox="0 0 36 36" fill="none"><rect x="8" y="2" width="20" height="32" rx="4" stroke="url(#logoGrad)" stroke-width="2"/><line x1="14" y1="6" x2="22" y2="6" stroke="url(#logoGrad)" stroke-width="2" stroke-linecap="round"/><circle cx="18" cy="28" r="2" stroke="url(#logoGrad)" stroke-width="1.5"/><path d="M13 14l3 3 7-7" stroke="url(#logoGrad)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><defs><linearGradient id="logoGrad" x1="0" y1="0" x2="36" y2="36"><stop stop-color="#818cf8"/><stop offset="1" stop-color="#22d3ee"/></linearGradient></defs></svg></div>
                <div class="logo-text">IPA<span>Auditor</span></div>
            </a>
            <nav class="nav-links">
                <a href="https://github.com/thecybersandeep/ipaauditor" class="nav-link" target="_blank">GitHub</a>
                <a href="https://adbauditor.com" class="nav-link" target="_blank">ADB Auditor</a>
            </nav>
        </div>
    </header>

    <main class="hero" id="landingContent">
        <div class="hero-badge">Comprehensive iOS Security Analysis</div>
        <h1 class="hero-title"><span class="gradient">IPA Auditor</span></h1>
        <p class="hero-subtitle">Professional iOS security auditing platform. Analyze IPA files entirely in your browser with 50+ security checks based on OWASP MASVS.</p>
        <div class="hero-actions">
            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Upload IPA</button>
            <a href="https://github.com/thecybersandeep/ipaauditor" class="btn btn-ghost" target="_blank"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0020 4.77 5.07 5.07 0 0019.91 1S18.73.65 16 2.48a13.38 13.38 0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 005 4.77a5.44 5.44 0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 009 18.13V22"/></svg>View Source</a>
        </div>
        <div class="hero-stats">
            <div class="hero-stat"><div class="hero-stat-value">50+</div><div class="hero-stat-label">Security Checks</div></div>
            <div class="hero-stat"><div class="hero-stat-value">100%</div><div class="hero-stat-label">Client-Side</div></div>
            <div class="hero-stat"><div class="hero-stat-value">OWASP</div><div class="hero-stat-label">MASVS Based</div></div>
        </div>
        <div class="dropzone" id="dropZone">
            <div class="dropzone-icon">
                <svg viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="20" y="4" width="40" height="72" rx="8" fill="url(#ipaGrad)" stroke="url(#ipaStroke)" stroke-width="2"/>
                    <rect x="32" y="8" width="16" height="4" rx="2" fill="rgba(255,255,255,0.3)"/>
                    <circle cx="40" cy="68" r="4" fill="rgba(255,255,255,0.3)"/>
                    <rect x="26" y="16" width="28" height="44" rx="2" fill="rgba(255,255,255,0.15)"/>
                    <path d="M40 28L40 48M40 48L32 40M40 48L48 40" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                    <defs>
                        <linearGradient id="ipaGrad" x1="20" y1="4" x2="60" y2="76">
                            <stop stop-color="#667eea"/>
                            <stop offset="0.5" stop-color="#764ba2"/>
                            <stop offset="1" stop-color="#6B8DD6"/>
                        </linearGradient>
                        <linearGradient id="ipaStroke" x1="20" y1="4" x2="60" y2="76">
                            <stop stop-color="#818cf8"/>
                            <stop offset="1" stop-color="#22d3ee"/>
                        </linearGradient>
                    </defs>
                </svg>
            </div>
            <div class="dropzone-title">Drag & Drop IPA File</div>
            <div class="dropzone-desc">or click anywhere to browse</div>
            <div class="dropzone-formats">
                <span class="format-tag"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>Secure Analysis</span>
                <span class="format-tag">.ipa</span>
                <span class="format-tag">iOS App</span>
            </div>
        </div>
        <input type="file" id="fileInput" class="file-input" accept=".ipa">
    </main>

    <section class="features-section" id="featuresSection">
        <div class="section-header">
            <span class="section-label">What It Does</span>
            <h2 class="section-title">Static Security Scanner</h2>
            <p class="section-desc">Pattern-based security analysis for iOS applications. Scans IPA contents and flags potential security issues for manual review.</p>
        </div>
        <div class="features-grid">
            <div class="feature-card"><div class="feature-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div><div class="feature-title">Security Scan</div><div class="feature-desc">Scans all files for 50+ vulnerability patterns including ATS misconfigurations, insecure storage, weak cryptography, and hardcoded secrets.</div></div>
            <div class="feature-card"><div class="feature-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg></div><div class="feature-title">Binary Analysis</div><div class="feature-desc">Extracts strings from Mach-O executable and checks for PIE, ARC, Stack Canary, and 64-bit compilation.</div></div>
            <div class="feature-card"><div class="feature-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg></div><div class="feature-title">Pattern Matching</div><div class="feature-desc">Searches for weak crypto usage (MD5, SHA1, DES), hardcoded secrets, API keys, and sensitive strings.</div></div>
            <div class="feature-card"><div class="feature-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></div><div class="feature-title">File Inspection</div><div class="feature-desc">Lists all files in the IPA bundle including plists, databases, certificates, and embedded resources.</div></div>
            <div class="feature-card"><div class="feature-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg></div><div class="feature-title">Permission Check</div><div class="feature-desc">Extracts requested entitlements and privacy permissions from the app bundle for review.</div></div>
            <div class="feature-card"><div class="feature-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg></div><div class="feature-title">File Explorer</div><div class="feature-desc">Browse all files in the IPA with hex viewer for binaries and syntax highlighting for text files.</div></div>
        </div>
    </section>

    <section class="privacy-section">
        <div class="privacy-card">
            <div class="privacy-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg></div>
            <h3 class="privacy-title">Your Files Never Leave Your Device</h3>
            <p class="privacy-desc">All analysis is performed entirely in your browser using JavaScript. No files are uploaded to any server.</p>
            <div class="privacy-badges">
                <div class="privacy-badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>Client-Side Only</div>
                <div class="privacy-badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>No Server Upload</div>
                <div class="privacy-badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>Open Source</div>
            </div>
        </div>
    </section>

    <div class="app-container" id="appContainer">
        <div class="app-header">
            <div class="app-title">
                <div class="app-icon" id="appIcon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="2" width="14" height="20" rx="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg></div>
                <div class="app-info"><h2 id="appName">App Name</h2><p id="bundleId">Bundle ID</p></div>
            </div>
            <div class="app-actions">
                <button class="btn btn-ghost" onclick="exportReport()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export Report</button>
                <button class="btn btn-primary" onclick="location.reload()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>New Scan</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="overview"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>Overview</button>
            <button class="tab" data-tab="findings"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>Findings<span class="tab-badge" id="findingsCount">0</span></button>
            <button class="tab" data-tab="binary"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>Binary</button>
            <button class="tab" data-tab="explorer"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>Explorer</button>
            </div>

        <div class="panel active" id="panel-overview">
            <div class="stats-grid" id="overviewStats"></div>
            <div class="results-section">
                <div class="results-header"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>Application Information</div>
                <div id="appInfoGrid" style="padding: 16px;"></div>
            </div>
            <div class="results-section">
                <div class="results-header"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>Permissions</div>
                <div id="permissionsList" style="padding: 16px;"></div>
            </div>
            <div class="results-section">
                <div class="results-header"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>URL Schemes</div>
                <div id="urlSchemesList" style="padding: 16px;"></div>
            </div>
            <div class="results-section">
                <div class="results-header"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/></svg>Trackers & SDKs</div>
                <div id="trackersList" style="padding: 16px;"></div>
            </div>
        </div>

        <div class="panel" id="panel-findings">
            <div class="filter-bar" id="filterBar">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="high">High</button>
                <button class="filter-btn" data-filter="warning">Warning</button>
                <button class="filter-btn" data-filter="info">Info</button>
                <button class="filter-btn" data-filter="secure">Secure</button>
            </div>
            <div class="results-section">
                <div class="results-header"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>Security Findings</div>
                <div id="findingsList" style="padding: 16px;"></div>
            </div>
        </div>

        <div class="panel" id="panel-binary">
            <div class="results-section">
                <div class="results-header"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>Security Checks (Checksec)</div>
                <div id="checksecGrid" style="padding: 16px;"></div>
            </div>
            <div class="results-section">
                <div class="results-header"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/></svg>Libraries</div>
                <div id="librariesList" style="padding: 16px; max-height: 300px; overflow-y: auto;"></div>
            </div>
        </div>

        <div class="panel" id="panel-explorer">
            <div class="explorer-container">
                <div class="explorer-sidebar">

                    <div class="quick-access" id="quickAccess">
                        <div class="quick-access-header">
                            <span> Quick Access</span>
                            <span class="quick-access-toggle" onclick="toggleQuickAccess()"></span>
                        </div>
                        <div class="quick-access-list" id="quickAccessList"></div>
                    </div>

                    <div class="explorer-controls">
                        <input type="text" id="fileSearchInput" placeholder=" Search files...">
                        <select id="fileTypeFilter" onchange="filterFileTree(this.value)">
                            <option value="">All Files</option>
                            <option value="plist">Plists</option>
                            <option value="json,xml">Data Files</option>
                            <option value="png,jpg,jpeg,gif">Images</option>
                            <option value="js,html,css">Web Files</option>
                            <option value="db,sqlite,sqlite3,realm">Databases</option>
                        </select>
                        <div class="tree-controls">
                            <button onclick="expandAllFolders()" title="Expand All"></button>
                            <button onclick="collapseAllFolders()" title="Collapse All"></button>
                        </div>
                    </div>
                    <div id="fileSearchResults"></div>

                    <div class="tree-section-header">
                        <span> Files</span>
                        <span class="tree-file-count" id="totalFileCount"></span>
                    </div>

                    <div class="file-tree-container" id="fileTree"></div>
                </div>
                <div class="explorer-main">

                    <div class="breadcrumb-bar" id="breadcrumbBar">
                        <span class="breadcrumb-item" onclick="navigateToBreadcrumb('')"> Root</span>
                    </div>
                    <div class="explorer-toolbar">
                        <span class="current-file-path" id="currentFilePath">Select a file to view</span>
                        <div class="viewer-actions">
                            <button class="viewer-btn" onclick="downloadCurrentFile()" title="Download file"></button>
                        </div>
                    </div>
                    <div class="file-viewer-container">
                        <div id="fileViewer"><div class="no-data">Select a file from Quick Access or the tree below</div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-inner">
            <div class="footer-brand">
                <a href="#" class="footer-logo" onclick="location.reload()">
                    <svg viewBox="0 0 36 36" fill="none" width="24" height="24"><rect x="8" y="2" width="20" height="32" rx="4" stroke="url(#footerGrad)" stroke-width="2"/><line x1="14" y1="6" x2="22" y2="6" stroke="url(#footerGrad)" stroke-width="2" stroke-linecap="round"/><circle cx="18" cy="28" r="2" stroke="url(#footerGrad)" stroke-width="1.5"/><path d="M13 14l3 3 7-7" stroke="url(#footerGrad)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><defs><linearGradient id="footerGrad" x1="0" y1="0" x2="36" y2="36"><stop stop-color="#818cf8"/><stop offset="1" stop-color="#22d3ee"/></linearGradient></defs></svg>
                    <span>IPA Auditor</span>
                </a>
                <span class="footer-divider">|</span>
                <a href="https://github.com/thecybersandeep/ipaauditor" class="footer-github" target="_blank" title="Star on GitHub">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                    <span>Star on GitHub</span>
                </a>
            </div>
            <div class="footer-copyright">
                 2026 A Project by <a href="https://github.com/thecybersandeep" target="_blank">Sandeep</a>
            </div>
        </div>
    </footer>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loader"></div>
        <div class="loading-text" id="loadingText">Analyzing IPA...</div>
        <div class="loading-subtext" id="progressText">Extracting files...</div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
    </div>
    <div class="toast-container" id="toastContainer"></div>

    <script src="ipa-analyzer.js" integrity="sha384-DcWBPDc7qIqC35f7QhvB4kZXE/eGTql/Fn7W4NI4b8m1Brifsvmd7AYWpXcUuqie" crossorigin="anonymous"></script>
    <script>

        function createParticles() {
            const field = document.getElementById('particleField');
            for (let i = 0; i < 50; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.left = Math.random() * 100 + '%';
                p.style.animationDelay = Math.random() * 15 + 's';
                p.style.animationDuration = (12 + Math.random() * 8) + 's';
                const colors = ['#818cf8', '#22d3ee', '#a855f7', '#34d399'];
                p.style.background = colors[Math.floor(Math.random() * colors.length)];
                field.appendChild(p);
            }
        }
        createParticles();

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', async (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.ipa')) await startAnalysis(file);
            else showToast('Please drop a valid .ipa file', 'error');
        });
        fileInput.addEventListener('change', async (e) => { if (e.target.files[0]) await startAnalysis(e.target.files[0]); });

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('panel-' + tab.dataset.tab).classList.add('active');
            });
        });

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                filterFindings(btn.dataset.filter);
            });
        });

        function filterFindings(filter) {
            document.querySelectorAll('#findingsList .finding-card').forEach(card => {
                card.style.display = (filter === 'all' || card.dataset.severity === filter) ? 'block' : 'none';
            });
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.innerHTML = (type === 'success'
                ? '<svg viewBox="0 0 24 24" fill="none" stroke="#34d399" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>'
                : '<svg viewBox="0 0 24 24" fill="none" stroke="#fb7185" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>')
                + message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        async function startAnalysis(file) {
            try {
                const results = await analyzeIPA(file);
                showResults(results);
                showToast('Analysis complete!', 'success');
            } catch (error) {
                console.error('Analysis failed:', error);
                hideLoading();
                showToast('Analysis failed: ' + error.message, 'error');
            }
        }

        function showResults(results) {
            hideLoading();
            document.getElementById('landingContent').style.display = 'none';
            document.getElementById('featuresSection').style.display = 'none';
            document.querySelector('.privacy-section').style.display = 'none';
            document.getElementById('appContainer').classList.add('active');

            document.getElementById('appName').textContent = results.appInfo.appName || 'Unknown App';
            document.getElementById('bundleId').textContent = results.appInfo.bundleId || 'Unknown';

            const totalFindings = state.groupedFindings.high.length + state.groupedFindings.warning.length +
                state.groupedFindings.info.length + state.groupedFindings.secure.length;
            document.getElementById('findingsCount').textContent = totalFindings;

            const appIconEl = document.getElementById('appIcon');
            if (results.appIcon) {
                appIconEl.innerHTML = `<img src="${results.appIcon}" alt="App Icon">`;
            } else {
                const appName = results.appInfo.appName || 'App';
                const firstLetter = appName.charAt(0).toUpperCase();
                appIconEl.innerHTML = `<span style="font-size: 24px; font-weight: 700; color: white;">${firstLetter}</span>`;
            }

            renderOverviewTab(results);
            renderFindingsTab(results);
            renderBinaryTab(results);
            renderExplorerTab(results);
        }

        function renderOverviewTab(results) {
            const highLen = state.groupedFindings.high.length;
            const warnLen = state.groupedFindings.warning.length;
            const infoLen = state.groupedFindings.info.length;
            const secureLen = state.groupedFindings.secure.length;

            document.getElementById('overviewStats').innerHTML = `
                <div class="stat-card findings-card">
                    <div class="stat-card-header"><span class="stat-card-label">Security Findings</span><div class="stat-card-icon accent"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div></div>
                    <div class="findings-vertical">
                        <div class="finding-row high"><span class="count" id="highCount">${highLen}</span><span class="label">High</span></div>
                        <div class="finding-row warning"><span class="count" id="warningCount">${warnLen}</span><span class="label">Warning</span></div>
                        <div class="finding-row info"><span class="count" id="infoCount">${infoLen}</span><span class="label">Info</span></div>
                        <div class="finding-row secure"><span class="count" id="secureCount">${secureLen}</span><span class="label">Secure</span></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header"><span class="stat-card-label">Files</span><div class="stat-card-icon cyan"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg></div></div>
                    <div class="stat-card-value">${results.files.length}</div>
                    <div class="stat-card-desc">In IPA package</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header"><span class="stat-card-label">Permissions</span><div class="stat-card-icon green"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div></div>
                    <div class="stat-card-value">${Object.keys(results.permissions).length}</div>
                    <div class="stat-card-desc">Requested</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header"><span class="stat-card-label">Trackers</span><div class="stat-card-icon orange"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></div></div>
                    <div class="stat-card-value">${results.trackers.length}</div>
                    <div class="stat-card-desc">SDKs detected</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header"><span class="stat-card-label">Libraries</span><div class="stat-card-icon red"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/></svg></div></div>
                    <div class="stat-card-value">${results.libraries.length}</div>
                    <div class="stat-card-desc">Linked</div>
                </div>
            `;

            const infoItems = [
                ['Bundle ID', results.appInfo.bundleId],
                ['Version', results.appInfo.version],
                ['Build', results.appInfo.build],
                ['Min iOS', results.appInfo.minOS],
                ['Executable', results.appInfo.executableName],
                ['Type', results.binType],
                ['Size', results.appInfo.fileSize]
            ];

            let infoHtml = `<div class="info-grid">${infoItems.filter(([,v]) => v).map(([k, v]) => `
                <div class="info-item"><label>${k}</label><div class="value">${escapeHtml(String(v))}</div></div>
            `).join('')}`;

            if (results.appInfo.sha256) {
                infoHtml += `<div class="info-item" style="grid-column: 1 / -1;"><label>SHA-256</label><div class="value hash">${results.appInfo.sha256}</div></div>`;
            }
            infoHtml += '</div>';
            document.getElementById('appInfoGrid').innerHTML = infoHtml;

            const perms = Object.entries(results.permissions);
            document.getElementById('permissionsList').innerHTML = perms.length === 0
                ? '<div class="no-data">No special permissions requested</div>'
                : `<div class="permissions-grid">${perms.map(([k, v]) => `
                    <div class="permission-item">
                        <div class="permission-header">
                            <span class="permission-name">${escapeHtml(v.name)}</span>
                        </div>
                        <div class="permission-key"><code>${escapeHtml(k)}</code></div>
                        <div class="permission-reason">
                            <span class="reason-label">App's stated reason:</span>
                            <span class="reason-text">"${escapeHtml(v.reason || 'No description provided')}"</span>
                        </div>
                    </div>
                `).join('')}</div>`;

            document.getElementById('urlSchemesList').innerHTML = results.urlSchemes.length === 0
                ? '<div class="no-data">No custom URL schemes</div>'
                : results.urlSchemes.map(s => `<span class="format-tag" style="margin: 4px;">${escapeHtml(s)}://</span>`).join('');

            document.getElementById('trackersList').innerHTML = results.trackers.length === 0
                ? '<div class="no-data">No trackers detected</div>'
                : results.trackers.map(t => `<span class="format-tag" style="margin: 4px; background: rgba(251, 146, 60, 0.15); color: var(--orange);">${escapeHtml(t)}</span>`).join('');
        }

        function renderFindingsTab(results) {
            const container = document.getElementById('findingsList');
            const allGrouped = [
                ...state.groupedFindings.high,
                ...state.groupedFindings.warning,
                ...state.groupedFindings.info,
                ...state.groupedFindings.secure
            ];

            if (allGrouped.length === 0) {
                container.innerHTML = '<div class="no-data">No security findings</div>';
                return;
            }

            container.innerHTML = allGrouped.map((f, i) => {
                const instanceCount = f.instances.length;
                const instancesHtml = f.instances.map((inst, j) => {
                    const isBinary = inst.file.startsWith('BINARY:');
                    const fileDisplay = isBinary ? inst.file.replace('BINARY:', '') + ' (Binary)' : inst.file;
                    const binaryName = isBinary ? inst.file.replace('BINARY:', '') : null;
                    const offset = inst.binaryOffset ? parseInt(inst.binaryOffset.replace('0x', ''), 16) : 0;
                    const clickHandler = isBinary
                        ? `onclick="navigateToBinary('${escapeJs(binaryName)}', ${offset})"`
                        : `onclick="navigateToFile('${escapeJs(inst.file)}', ${parseInt(inst.line) || 0})"`;
                    return `
                    <div class="instance-item">
                        <div class="instance-header">
                            <span class="instance-number">#${j + 1}</span>
                            <span class="instance-file clickable" ${clickHandler}>${escapeHtml(fileDisplay)}${inst.line ? ':' + inst.line : ''}</span>
                            ${inst.binaryOffset ? `<span class="instance-offset">@ ${inst.binaryOffset}</span>` : ''}
                        </div>
                        <div class="instance-match"><code>${escapeHtml(inst.match)}</code></div>
                        <pre class="instance-snippet">${escapeHtml(inst.snippet)}</pre>
                    </div>
                `}).join('');

                return `
                    <div class="finding-card ${f.severity}" data-severity="${f.severity}" data-finding-id="${i}">
                        <div class="finding-header" onclick="toggleFinding(${i})">
                            <span class="severity-badge ${f.severity}">${f.severity.toUpperCase()}</span>
                            <span class="finding-title">${escapeHtml(f.ruleName)}</span>
                            <span class="instance-count">${instanceCount} instance${instanceCount > 1 ? 's' : ''}</span>
                            <span class="finding-toggle"></span>
                        </div>
                        <div class="finding-body" id="finding-body-${i}">
                            <div class="finding-description">${escapeHtml(f.description)}</div>
                            <div class="finding-meta">
                                ${f.cwe ? `<span class="meta-tag">CWE: ${f.cwe}</span>` : ''}
                                ${f.owasp ? `<span class="meta-tag">OWASP: ${f.owasp}</span>` : ''}
                                ${f.masvs ? `<span class="meta-tag">MASVS: ${f.masvs}</span>` : ''}
                            </div>
                            <div class="instances-section">
                                <div class="instances-header">Found in ${instanceCount} location${instanceCount > 1 ? 's' : ''}:</div>
                                <div style="max-height: 400px; overflow-y: auto;">${instancesHtml}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleFinding(idx) {
            const body = document.getElementById(`finding-body-${idx}`);
            if (body) body.classList.toggle('expanded');
        }

        function navigateToFile(filePath, line) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelector('[data-tab="explorer"]').classList.add('active');
            document.getElementById('panel-explorer').classList.add('active');
            openFileInExplorer(filePath, line);
        }

        function navigateToBinary(binaryName, offset) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelector('[data-tab="explorer"]').classList.add('active');
            document.getElementById('panel-explorer').classList.add('active');

            const binaryPath = explorerFileList.find(f => f.endsWith('/' + binaryName) || f === binaryName);
            if (binaryPath) {
                openFileInExplorer(binaryPath).then(() => {
                    setTimeout(() => {
                        // Switch to Hex mode (not strings)
                        hexViewer.mode = 'hex';
                        hexViewer.highlightOffset = offset;
                        hexViewer.highlightLength = 32;
                        
                        // Refresh the viewer to show hex mode
                        refreshBinaryViewer();
                        
                        // Then jump to the offset
                        setTimeout(() => {
                            gotoHexOffset('0x' + offset.toString(16));
                            renderVisibleHexLines();
                        }, 100);
                    }, 200);
                });
            } else {
                showToast('Binary file not found in explorer', 'error');
            }
        }

        function renderBinaryTab(results) {
            const checks = [
                ['PIE (ASLR)', results.checksec.pie, 'Position Independent Executable'],
                ['ARC', results.checksec.arc, 'Automatic Reference Counting'],
                ['Stack Canary', results.checksec.canary, 'Buffer overflow protection'],
                ['64-bit', results.checksec.is64bit, 'Modern architecture']
            ];

            document.getElementById('checksecGrid').innerHTML = `
                <div class="checksec-grid">
                    ${checks.map(([name, ok, desc]) => `
                        <div class="checksec-item ${ok ? 'pass' : 'fail'}">
                            <div class="checksec-status">${ok ? '' : ''}</div>
                            <div class="checksec-info"><div class="checksec-name">${name}</div><div class="checksec-desc">${desc}</div></div>
                        </div>
                    `).join('')}
                </div>
            `;

            document.getElementById('librariesList').innerHTML = results.libraries.length === 0
                ? '<div class="no-data">No libraries detected</div>'
                : results.libraries.map(l => `<div class="library-item">${escapeHtml(l)}</div>`).join('');
        }

        let explorerFileList = [];
        let explorerFileTree = null;
        let currentOpenFile = '';

        function renderExplorerTab(results) {
            explorerFileTree = results.fileTree;
            explorerFileList = results.files || [];

            const treeContainer = document.getElementById('fileTree');
            treeContainer.innerHTML = buildFileTree(results.fileTree, '');

            const fileCountEl = document.getElementById('totalFileCount');
            if (fileCountEl) {
                fileCountEl.textContent = explorerFileList.length + ' files';
            }

            populateQuickAccess(results);

            setupExplorerSearch();
        }

        function populateQuickAccess(results) {
            const quickAccessList = document.getElementById('quickAccessList');
            const found = {
                infoPlist: null,
                entitlements: null,
                provisioning: null,
                binary: null
            };
            const extras = [];

            const sortedFiles = [...explorerFileList].sort((a, b) => a.length - b.length);

            for (const filePath of sortedFiles) {
                const fileName = filePath.split('/').pop().toLowerCase();
                const fullLower = filePath.toLowerCase();

                const isFramework = fullLower.includes('.framework/') || fullLower.includes('.appex/') || fullLower.includes('pluginkit/');

                if (fileName === 'info.plist' && !found.infoPlist && !isFramework) {
                    found.infoPlist = { path: filePath, name: 'Info.plist', icon: '', desc: 'App configuration' };
                } else if (fileName.includes('entitlements') && !found.entitlements && !isFramework) {
                    found.entitlements = { path: filePath, name: 'Entitlements', icon: '', desc: 'App capabilities' };
                } else if (fileName === 'embedded.mobileprovision' && !found.provisioning) {
                    found.provisioning = { path: filePath, name: 'Provisioning', icon: '', desc: 'Code signing' };
                } else if ((fileName.endsWith('.sqlite') || fileName.endsWith('.db')) && extras.length < 3) {
                    extras.push({ path: filePath, name: fileName.length > 15 ? fileName.slice(0, 12) + '...' : fileName, icon: '', desc: 'Database' });
                }
            }

            if (results.appInfo.executableName) {
                const binPath = explorerFileList.find(f => f.endsWith('/' + results.appInfo.executableName) || f === results.appInfo.executableName);
                if (binPath) {
                    found.binary = { path: binPath, name: 'Binary', icon: '', desc: results.appInfo.executableName };
                }
            }

            const items = [found.binary, found.infoPlist, found.entitlements, found.provisioning, ...extras].filter(Boolean);

            quickAccessList.innerHTML = items.length === 0
                ? '<span class="qa-empty">No key files found</span>'
                : items.map(f => `
                    <div class="quick-access-item" onclick="openFileInExplorer('${escapeJs(f.path)}')" title="${escapeAttr(f.path)}">
                        <span class="qa-icon">${f.icon}</span>
                        <div class="qa-text">
                            <span class="qa-name">${escapeHtml(f.name)}</span>
                            <span class="qa-desc">${escapeHtml(f.desc)}</span>
                        </div>
                    </div>
                `).join('');
        }

        function toggleQuickAccess() {
            const qa = document.getElementById('quickAccess');
            const toggle = qa.querySelector('.quick-access-toggle');
            qa.classList.toggle('collapsed');
            toggle.textContent = qa.classList.contains('collapsed') ? '+' : '';
        }

        function setupExplorerSearch() {
            const searchInput = document.getElementById('fileSearchInput');
            const searchResults = document.getElementById('fileSearchResults');

            const newInput = searchInput.cloneNode(true);
            searchInput.parentNode.replaceChild(newInput, searchInput);

            newInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase().trim();
                if (query.length >= 2) {
                    const matches = explorerFileList.filter(f => f.toLowerCase().includes(query)).slice(0, 30);
                    searchResults.innerHTML = matches.length > 0
                        ? matches.map(f => {
                            const fileName = f.split('/').pop();
                            return `<div class="search-result-item" onclick="openFileInExplorer('${escapeJs(f)}')">
                                <span style="color: var(--cyan);">${escapeHtml(fileName)}</span>
                                <span style="color: var(--text-muted); font-size: 9px; display: block;">${escapeHtml(f)}</span>
                            </div>`;
                        }).join('')
                        : '<div class="search-result-item" style="color: var(--text-muted);">No matches</div>';
                } else {
                    searchResults.innerHTML = '';
                }
            });
        }

        function filterFileTree(extFilter) {
            const exts = extFilter ? extFilter.split(',').map(e => e.trim().toLowerCase()) : [];
            const allFiles = document.querySelectorAll('.tree-file');
            const allFolders = document.querySelectorAll('.tree-folder');

            if (exts.length === 0) {

                allFiles.forEach(f => f.classList.remove('filtered'));
                allFolders.forEach(f => { f.classList.remove('filtered', 'has-match'); });
                return;
            }

            allFiles.forEach(file => {
                const path = file.dataset.path || '';
                const ext = path.split('.').pop().toLowerCase();
                if (exts.includes(ext)) {
                    file.classList.remove('filtered');
                    file.classList.add('match');
                } else {
                    file.classList.add('filtered');
                    file.classList.remove('match');
                }
            });

            allFolders.forEach(folder => {
                const hasMatch = folder.querySelector('.tree-file.match');
                if (hasMatch) {
                    folder.classList.add('has-match');
                    folder.classList.remove('filtered');
                } else {
                    folder.classList.add('filtered');
                    folder.classList.remove('has-match');
                }
            });
        }

        function toggleFolder(header) {
            const folder = header.parentElement;
            const isOpen = folder.classList.toggle('open');
            const icon = header.querySelector('.folder-icon');
            if (icon) {
                icon.textContent = isOpen ? '' : '';
            }
        }

        function expandAllFolders() {
            document.querySelectorAll('.tree-folder').forEach(f => {
                f.classList.add('open');
                const icon = f.querySelector('.folder-icon');
                if (icon) icon.textContent = '';
            });
        }

        function collapseAllFolders() {
            document.querySelectorAll('.tree-folder').forEach(f => {
                f.classList.remove('open');
                const icon = f.querySelector('.folder-icon');
                if (icon) icon.textContent = '';
            });
        }

        function countFilesInFolder(node) {
            let count = 0;
            for (const [key, val] of Object.entries(node)) {
                if (key.startsWith('_')) continue;
                if (val._type === 'dir') count += countFilesInFolder(val);
                else count++;
            }
            return count;
        }

        function buildFileTree(tree, prefix) {
            let html = '';
            const entries = Object.entries(tree).filter(([k]) => !k.startsWith('_')).sort((a, b) => {
                const aIsDir = a[1]._type === 'dir';
                const bIsDir = b[1]._type === 'dir';
                if (aIsDir !== bIsDir) return aIsDir ? -1 : 1;
                return a[0].localeCompare(b[0]);
            });

            for (const [name, node] of entries) {
                if (node._type === 'dir') {
                    const fileCount = countFilesInFolder(node);
                    html += `
                        <div class="tree-folder">
                            <div class="tree-folder-header" onclick="toggleFolder(this)" title="${escapeAttr(prefix + name)}">
                                <span class="folder-chevron"></span>
                                <span class="folder-icon"></span>
                                <span class="folder-name">${escapeHtml(name)}</span>
                                <span class="folder-count">${fileCount}</span>
                            </div>
                            <div class="tree-folder-content">${buildFileTree(node, prefix + name + '/')}</div>
                        </div>
                    `;
                } else {
                    const ext = name.split('.').pop().toLowerCase();
                    const icon = getFileIcon(ext);
                    const lowerName = name.toLowerCase();

                    const isImportant = lowerName === 'info.plist' ||
                                        lowerName.includes('entitlements') ||
                                        lowerName === 'embedded.mobileprovision' ||
                                        ext === 'sqlite' || ext === 'db' || ext === 'realm';
                    html += `
                        <div class="tree-file${isImportant ? ' important' : ''}" onclick="openFileInExplorer('${escapeJs(node._path)}')" data-path="${escapeAttr(node._path)}" data-ext="${ext}" title="${escapeAttr(node._path)}">
                            <span class="file-icon">${icon}</span>
                            <span class="file-name">${escapeHtml(name)}</span>
                        </div>
                    `;
                }
            }
            return html;
        }

        function getFileIcon(ext) {
            const icons = {

                'swift': '', 'm': '', 'h': '', 'c': '', 'cpp': '',

                'plist': '', 'json': '', 'xml': '', 'yaml': '', 'yml': '',

                'db': '', 'sqlite': '', 'sqlite3': '', 'realm': '', 'sql': '',

                'png': '', 'jpg': '', 'jpeg': '', 'gif': '', 'svg': '', 'webp': '', 'ico': '', 'icns': '',

                'js': '', 'html': '', 'css': '', 'ts': '',

                'strings': '', 'stringsdict': '', 'lproj': '',

                'cer': '', 'pem': '', 'p12': '', 'mobileprovision': '', 'entitlements': '',

                'dylib': '', 'framework': '', 'a': '', 'o': '',

                'car': '', 'nib': '', 'storyboardc': '', 'xib': '',

                'mom': '', 'momd': '', 'omo': '',

                'mp3': '', 'wav': '', 'caf': '', 'mp4': '', 'mov': '',

                'ttf': '', 'otf': '', 'woff': '', 'woff2': '',

                'zip': '', 'tar': '', 'gz': '',

                'txt': '', 'md': '', 'rtf': '', 'pdf': '',

                'log': ''
            };
            return icons[ext] || '';
        }

        function updateBreadcrumb(filePath) {
            const breadcrumb = document.getElementById('breadcrumbBar');
            const parts = filePath.split('/').filter(p => p);
            let html = '<span class="breadcrumb-item" onclick="navigateToBreadcrumb(\'\')"></span>';

            let path = '';
            for (let i = 0; i < parts.length; i++) {
                path += (path ? '/' : '') + parts[i];
                const isLast = i === parts.length - 1;
                html += `<span class="breadcrumb-sep"></span>`;
                html += `<span class="breadcrumb-item${isLast ? ' active' : ''}" onclick="navigateToBreadcrumb('${escapeJs(path)}')">${escapeHtml(parts[i])}</span>`;
            }
            breadcrumb.innerHTML = html;
        }

        function navigateToBreadcrumb(path) {

            collapseAllFolders();
            if (!path) return;

            const parts = path.split('/');
            let currentPath = '';
            for (const part of parts) {
                currentPath += (currentPath ? '/' : '') + part;
                const folder = document.querySelector(`.tree-folder-header[title="${CSS.escape(currentPath)}"]`);
                if (folder) folder.parentElement.classList.add('open');
            }
        }

        async function downloadCurrentFile() {
            if (!currentOpenFile) {
                showToast('No file selected', 'error');
                return;
            }

            try {
                const fileName = currentOpenFile.split('/').pop();
                const fullPath = state.appPath + currentOpenFile;
                const file = state.zipContent.file(fullPath) || state.zipContent.file(currentOpenFile);

                if (!file) {
                    showToast('File not found in archive', 'error');
                    return;
                }

                const data = await file.async('blob');
                const a = document.createElement('a');
                a.href = URL.createObjectURL(data);
                a.download = fileName;
                a.click();
                URL.revokeObjectURL(a.href);
                showToast(`Downloaded ${fileName}`, 'success');
            } catch (e) {
                showToast('Download failed: ' + e.message, 'error');
            }
        }

        async function openFileInExplorer(filePath, highlightLine = 0) {
            const viewer = document.getElementById('fileViewer');
            const pathDisplay = document.getElementById('currentFilePath');

            currentOpenFile = filePath;

            updateBreadcrumb(filePath);

            document.querySelectorAll('.tree-file').forEach(f => f.classList.remove('active'));
            const treeFile = document.querySelector(`.tree-file[data-path="${CSS.escape(filePath)}"]`);
            if (treeFile) {
                treeFile.classList.add('active');

                let parent = treeFile.parentElement;
                while (parent) {
                    if (parent.classList.contains('tree-folder')) {
                        parent.classList.add('open');
                    }
                    parent = parent.parentElement;
                }

                treeFile.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            pathDisplay.textContent = filePath;
            viewer.innerHTML = '<div class="no-data">Loading...</div>';

            try {
                const content = await loadFileContent(filePath);

                if (!content) {
                    viewer.innerHTML = '<div class="no-data">Unable to load file</div>';
                    return;
                }

                if (content.type === 'image') {
                    if (content.crushed) {
                        viewer.innerHTML = `
                            <div class="image-viewer">
                                <div class="image-info">
                                    <span class="hex-info-badge">${content.ext.toUpperCase()}</span>
                                    <span class="hex-info-badge">${formatSize(content.size)}</span>
                                    <span class="hex-info-badge" style="background: rgba(251,146,60,0.2); color: var(--orange);">iOS Optimized</span>
                                </div>
                                <div class="no-data" style="margin-top: 24px;">
                                    <div style="font-size: 48px; margin-bottom: 16px;"></div>
                                    <div>This PNG uses Apple's CgBI (crushed) format</div>
                                    <div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">iOS-optimized images cannot be displayed in browsers</div>
                                </div>
                            </div>
                        `;
                    } else {
                        viewer.innerHTML = `
                            <div class="image-viewer">
                                <div class="image-info">
                                    <span class="hex-info-badge">${content.ext.toUpperCase()}</span>
                                    <span class="hex-info-badge">${formatSize(content.size)}</span>
                                </div>
                                <div class="image-container"><img src="${content.dataUrl}" alt="${escapeHtml(filePath)}" /></div>
                            </div>
                        `;
                    }
                    return;
                }

                if (content.type === 'binary') {
                    renderBinaryViewer(viewer, content, filePath);
                    return;
                }

                if (typeof content === 'string') {
                    const lines = content.split('\n');
                    viewer.innerHTML = `
                        <div class="code-viewer">
                            ${lines.map((line, i) => {
                                const lineNum = i + 1;
                                const isHighlight = lineNum === highlightLine;
                                return `<div class="code-line ${isHighlight ? 'highlight-line' : ''}" id="line-${lineNum}">
                                    <span class="line-num">${lineNum}</span>
                                    <span class="line-content">${escapeHtml(line)}</span>
                                </div>`;
                            }).join('')}
                        </div>
                    `;

                    if (highlightLine > 0) {
                        setTimeout(() => {
                            const el = document.getElementById(`line-${highlightLine}`);
                            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 100);
                    }
                    return;
                }

                viewer.innerHTML = '<div class="no-data">Unable to display file</div>';
            } catch (e) {
                console.error('Error loading file:', e);
                viewer.innerHTML = `<div class="no-data">Error: ${escapeHtml(e.message)}</div>`;
            }
        }

        const hexViewer = {
            data: null,
            size: 0,
            lineHeight: 24,
            visibleLines: 18,
            bufferLines: 5,
            scrollTop: 0,
            searchQuery: '',
            searchResults: [],
            currentMatch: -1,
            mode: 'hex',
            stringsFilter: '',
            extractedStrings: null,
            filteredStrings: null,
            stringsMatchIndices: [],
            stringsCurrentMatch: 0,
            stringsMatchCount: 0,
            highlightOffset: undefined,
            highlightLength: 0
        };

        function renderBinaryViewer(container, content, filePath) {
            const { data, header, size } = content;

            hexViewer.data = data;
            hexViewer.size = size;
            hexViewer.scrollTop = 0;

            if (!hexViewer.extractedStrings) {
                hexViewer.extractedStrings = extractStringsFromData(data, 4);
            }

            const totalLines = Math.ceil(size / 16);
            const totalHeight = totalLines * hexViewer.lineHeight;

            let html = `
                <div class="hex-viewer">
                    <div class="hex-header">
                        <span class="hex-info-badge format">${escapeHtml(header.format)}</span>
                        ${header.details.map(d => `<span class="hex-info-badge">${escapeHtml(d)}</span>`).join('')}
                        <span class="hex-info-badge">${totalLines.toLocaleString()} lines</span>
                    </div>
                    <div class="view-mode-tabs">
                        <button class="view-mode-tab ${hexViewer.mode === 'hex' ? 'active' : ''}" onclick="switchBinaryMode('hex')">Hex Dump</button>
                        <button class="view-mode-tab ${hexViewer.mode === 'strings' ? 'active' : ''}" onclick="switchBinaryMode('strings')">Strings</button>
                    </div>
            `;

            if (hexViewer.mode === 'hex') {
                html += `
                    <div class="hex-search-bar">
                        <input type="text" class="hex-search-input" placeholder="Search string or hex..." value="${escapeHtml(hexViewer.searchQuery)}" id="hexSearchInput">
                        <button class="hex-nav-btn" onclick="performHexSearch()">Find</button>
                        <button class="hex-nav-btn" onclick="navigateHexMatch(-1)" ${hexViewer.searchResults.length === 0 ? 'disabled' : ''}>&lt;</button>
                        <button class="hex-nav-btn" onclick="navigateHexMatch(1)" ${hexViewer.searchResults.length === 0 ? 'disabled' : ''}>&gt;</button>
                        <span class="hex-search-info">${hexViewer.searchResults.length > 0 ? `${hexViewer.currentMatch + 1} / ${hexViewer.searchResults.length}` : '0 / 0'}</span>
                        <div style="flex:1"></div>
                        <input type="text" class="hex-jump-input" placeholder="Go to 0x..." id="hexJumpInput">
                    </div>
                    <div class="hex-scroll-container" id="hexScrollContainer">
                        <div class="hex-table-header">
                            <span>Offset</span>
                            <span>00 01 02 03 04 05 06 07  08 09 0A 0B 0C 0D 0E 0F</span>
                            <span>ASCII</span>
                        </div>
                        <div class="hex-virtual-content" style="height: ${totalHeight}px;">
                            <div class="hex-lines-container" id="hexLinesContainer"></div>
                        </div>
                    </div>
                    <div class="hex-status-bar">
                        <span>Scroll to navigate &nbsp;|&nbsp; <span class="hex-position" id="hexPosition">0x00000000</span></span>
                        <span>${formatSize(size)}</span>
                    </div>
                `;
            } else {

                const filter = hexViewer.stringsFilter.toLowerCase();
                const filtered = filter
                    ? hexViewer.extractedStrings.filter(s => s.str.toLowerCase().includes(filter))
                    : hexViewer.extractedStrings;

                hexViewer.filteredStrings = filtered;

                html += `
                    <div class="strings-filter-bar">
                        <input type="text" class="strings-filter-input" placeholder="Search strings..." value="${escapeHtml(hexViewer.stringsFilter)}" id="stringsSearchInput">
                        <button class="hex-nav-btn" onclick="searchStrings()">Find</button>
                        <button class="hex-nav-btn" onclick="navigateStringMatch(-1)" ${!hexViewer.stringsMatchCount ? 'disabled' : ''}>&lt;</button>
                        <button class="hex-nav-btn" onclick="navigateStringMatch(1)" ${!hexViewer.stringsMatchCount ? 'disabled' : ''}>&gt;</button>
                        <span class="hex-search-info">${hexViewer.stringsMatchCount > 0 ? `${hexViewer.stringsCurrentMatch + 1} / ${hexViewer.stringsMatchCount}` : '0 / 0'}</span>
                        <div style="flex:1"></div>
                        <span class="strings-count">${filtered.length.toLocaleString()} strings</span>
                    </div>
                    <div class="hex-scroll-container" id="stringsScrollContainer">
                        <div class="hex-virtual-content" id="stringsVirtualContent" style="height: ${filtered.length * 28}px;">
                            <div class="hex-lines-container" id="stringsLinesContainer"></div>
                        </div>
                    </div>
                    <div class="hex-status-bar">
                        <span>Click a string to view in Hex</span>
                        <span>${filtered.length.toLocaleString()} strings</span>
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML = html;

            if (hexViewer.mode === 'hex') {
                const scrollContainer = document.getElementById('hexScrollContainer');
                if (scrollContainer) {
                    scrollContainer.addEventListener('scroll', handleHexScroll);
                    renderVisibleHexLines();
                }

                const searchInput = document.getElementById('hexSearchInput');
                if (searchInput) {
                    searchInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') performHexSearch();
                    });
                }

                const jumpInput = document.getElementById('hexJumpInput');
                if (jumpInput) {
                    jumpInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') gotoHexOffset(jumpInput.value);
                    });
                }
            } else {
                const scrollContainer = document.getElementById('stringsScrollContainer');
                if (scrollContainer) {
                    scrollContainer.addEventListener('scroll', handleStringsScroll);
                    renderVisibleStrings();
                }

                const stringsInput = document.getElementById('stringsSearchInput');
                if (stringsInput) {
                    stringsInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') searchStrings();
                    });
                }
            }
        }

        function handleHexScroll() {
            const container = document.getElementById('hexScrollContainer');
            if (!container) return;

            hexViewer.scrollTop = container.scrollTop;
            renderVisibleHexLines();

            const firstVisibleLine = Math.floor(hexViewer.scrollTop / hexViewer.lineHeight);
            const offset = firstVisibleLine * 16;
            const posEl = document.getElementById('hexPosition');
            if (posEl) {
                posEl.textContent = '0x' + offset.toString(16).toUpperCase().padStart(8, '0');
            }
        }

        function renderVisibleHexLines() {
            const container = document.getElementById('hexLinesContainer');
            if (!container || !hexViewer.data) return;

            const totalLines = Math.ceil(hexViewer.size / 16);
            const firstVisible = Math.max(0, Math.floor(hexViewer.scrollTop / hexViewer.lineHeight) - hexViewer.bufferLines);
            const lastVisible = Math.min(totalLines, firstVisible + hexViewer.visibleLines + hexViewer.bufferLines * 2);

            const searchMatchOffset = hexViewer.searchResults[hexViewer.currentMatch];
            const searchLen = hexViewer.searchQuery.length;
            const stringHighlightOffset = hexViewer.highlightOffset;
            const stringHighlightLen = hexViewer.highlightLength || 0;

            let html = '';
            for (let lineIdx = firstVisible; lineIdx < lastVisible; lineIdx++) {
                const offset = lineIdx * 16;
                const lineEnd = Math.min(offset + 16, hexViewer.size);
                let hexParts = [];
                let asciiParts = [];

                for (let j = offset; j < lineEnd; j++) {
                    const byte = hexViewer.data[j];
                    const hexByte = byte.toString(16).padStart(2, '0').toUpperCase();

                    const isSearchHighlight = searchMatchOffset !== undefined && j >= searchMatchOffset && j < searchMatchOffset + searchLen;
                    const isStringHighlight = stringHighlightOffset !== undefined && j >= stringHighlightOffset && j < stringHighlightOffset + stringHighlightLen;
                    const isHighlight = isSearchHighlight || isStringHighlight;

                    let byteClass = 'hex-byte';
                    let asciiClass = 'hex-ascii-char';
                    let asciiChar;

                    if (byte === 0) {
                        byteClass += ' null';
                        asciiClass += ' null';
                        asciiChar = '';
                    } else if (byte >= 32 && byte <= 126) {
                        byteClass += ' printable';
                        asciiClass += ' printable';
                        asciiChar = String.fromCharCode(byte);
                    } else if (byte < 32) {
                        asciiClass += ' control';
                        asciiChar = '';
                    } else {
                        byteClass += ' high';
                        asciiChar = '';
                    }

                    if ((j - offset) === 8) {
                        hexParts.push('<span class="hex-byte-gap"></span>');
                    }

                    if (isHighlight) {
                        hexParts.push(`<span class="${byteClass} hex-highlight">${hexByte}</span>`);
                        asciiParts.push(`<span class="${asciiClass} hex-highlight">${escapeHtml(asciiChar)}</span>`);
                    } else {
                        hexParts.push(`<span class="${byteClass}">${hexByte}</span>`);
                        asciiParts.push(`<span class="${asciiClass}">${escapeHtml(asciiChar)}</span>`);
                    }
                }

                const remaining = 16 - (lineEnd - offset);
                for (let k = 0; k < remaining; k++) {
                    if ((lineEnd - offset + k) === 8) hexParts.push('<span class="hex-byte-gap"></span>');
                    hexParts.push('<span class="hex-byte">  </span>');
                    asciiParts.push('<span class="hex-ascii-char"> </span>');
                }

                const top = lineIdx * hexViewer.lineHeight;
                html += `<div class="hex-line" style="position:absolute;top:${top}px;left:0;right:0;">
                    <span class="hex-offset">${offset.toString(16).padStart(8, '0').toUpperCase()}</span>
                    <span class="hex-bytes">${hexParts.join('')}</span>
                    <span class="hex-ascii">${asciiParts.join('')}</span>
                </div>`;
            }

            container.innerHTML = html;
        }

        function handleStringsScroll() {
            renderVisibleStrings();
        }

        function renderVisibleStrings() {
            const container = document.getElementById('stringsLinesContainer');
            const scrollContainer = document.getElementById('stringsScrollContainer');
            if (!container || !scrollContainer || !hexViewer.extractedStrings) return;

            const strings = hexViewer.filteredStrings || hexViewer.extractedStrings;

            const lineHeight = 28;
            const scrollTop = scrollContainer.scrollTop;
            const containerHeight = scrollContainer.clientHeight || 400;
            const bufferLines = 5;
            const visibleCount = Math.ceil(containerHeight / lineHeight) + bufferLines * 2;
            const firstVisible = Math.max(0, Math.floor(scrollTop / lineHeight) - bufferLines);
            const lastVisible = Math.min(strings.length, firstVisible + visibleCount);

            let html = '';
            for (let i = firstVisible; i < lastVisible; i++) {
                const s = strings[i];
                const top = i * lineHeight;
                const isCurrentMatch = hexViewer.stringsMatchCount > 0 && i === hexViewer.stringsCurrentMatch;
                html += `<div class="string-entry${isCurrentMatch ? ' current-match' : ''}" style="position:absolute;top:${top}px;left:0;right:0;height:${lineHeight}px;" onclick="jumpToStringOffset(${s.offset}, '${escapeJs(s.str.substring(0, 50))}')">
                    <span class="string-index">${i + 1}</span>
                    <span class="string-offset">0x${s.offset.toString(16).toUpperCase().padStart(8, '0')}</span>
                    <span class="string-value">${escapeHtml(s.str.length > 120 ? s.str.slice(0, 120) + '...' : s.str)}</span>
                </div>`;
            }

            container.innerHTML = html;
        }

        function extractStringsFromData(data, minLength = 4) {
            const strings = [];
            let currentStr = '';
            let startOffset = 0;

            for (let i = 0; i < data.length; i++) {
                const byte = data[i];
                if (byte >= 32 && byte <= 126) {
                    if (currentStr.length === 0) startOffset = i;
                    currentStr += String.fromCharCode(byte);
                } else {
                    if (currentStr.length >= minLength) {
                        strings.push({ offset: startOffset, str: currentStr });
                    }
                    currentStr = '';
                }
            }
            if (currentStr.length >= minLength) {
                strings.push({ offset: startOffset, str: currentStr });
            }
            return strings;
        }

        function switchBinaryMode(mode) {
            hexViewer.mode = mode;
            refreshBinaryViewer();
        }

        function gotoHexOffset(val) {
            let offset = parseInt(val.replace(/^0x/i, ''), 16);
            if (!isNaN(offset) && hexViewer.size > 0) {
                offset = Math.max(0, Math.min(hexViewer.size - 1, offset));
                const lineOffset = Math.floor(offset / 16);
                const scrollTop = lineOffset * hexViewer.lineHeight;

                const container = document.getElementById('hexScrollContainer');
                if (container) {
                    container.scrollTop = scrollTop;
                }
            }
        }

        function performHexSearch() {
            const input = document.getElementById('hexSearchInput');
            const query = input ? input.value.trim() : '';
            
            if (!hexViewer.data) return;

            hexViewer.highlightOffset = undefined;
            hexViewer.highlightLength = 0;

            // Handle clearing search
            if (!query) {
                hexViewer.searchQuery = '';
                hexViewer.searchResults = [];
                hexViewer.currentMatch = -1;
                updateHexSearchButtons();
                renderVisibleHexLines();
                return;
            }

            hexViewer.searchQuery = query;
            hexViewer.searchResults = searchBinaryData(hexViewer.data, query);
            hexViewer.currentMatch = hexViewer.searchResults.length > 0 ? 0 : -1;

            // Update navigation buttons disabled state
            updateHexSearchButtons();

            if (hexViewer.searchResults.length > 0) {

                const matchOffset = hexViewer.searchResults[0];
                const lineOffset = Math.floor(matchOffset / 16);
                const scrollTop = Math.max(0, (lineOffset - 5) * hexViewer.lineHeight);

                const container = document.getElementById('hexScrollContainer');
                if (container) {
                    container.scrollTop = scrollTop;

                    hexViewer.scrollTop = scrollTop;
                    renderVisibleHexLines();
                }

                showToast(`Found ${hexViewer.searchResults.length} matches`, 'success');
            } else {
                showToast('No matches found', 'error');
                renderVisibleHexLines();
            }
        }

        function updateHexSearchButtons() {
            const searchBar = document.querySelector('.hex-search-bar');
            if (!searchBar) return;
            
            const buttons = searchBar.querySelectorAll('.hex-nav-btn');
            // buttons[0] is Find, buttons[1] is Prev (<), buttons[2] is Next (>)
            const prevBtn = buttons[1];
            const nextBtn = buttons[2];
            
            if (prevBtn) {
                prevBtn.disabled = hexViewer.searchResults.length === 0;
            }
            if (nextBtn) {
                nextBtn.disabled = hexViewer.searchResults.length === 0;
            }
            
            // Also update the search info text
            const searchInfo = searchBar.querySelector('.hex-search-info');
            if (searchInfo) {
                searchInfo.textContent = hexViewer.searchResults.length > 0 
                    ? `${hexViewer.currentMatch + 1} / ${hexViewer.searchResults.length}` 
                    : '0 / 0';
            }
        }

        function navigateHexMatch(direction) {
            if (hexViewer.searchResults.length === 0) return;

            hexViewer.currentMatch = (hexViewer.currentMatch + direction + hexViewer.searchResults.length) % hexViewer.searchResults.length;
            const matchOffset = hexViewer.searchResults[hexViewer.currentMatch];
            const lineOffset = Math.floor(matchOffset / 16);
            const scrollTop = lineOffset * hexViewer.lineHeight;

            const container = document.getElementById('hexScrollContainer');
            if (container) {
                container.scrollTop = scrollTop;
            }

            renderVisibleHexLines(); // Update highlighting

            const searchInfo = document.querySelector('.hex-search-info');
            if (searchInfo) {
                searchInfo.textContent = `${hexViewer.currentMatch + 1} / ${hexViewer.searchResults.length}`;
            }
        }

        function searchBinaryData(data, query) {
            const results = [];
            const queryBytes = [];
            for (let i = 0; i < query.length; i++) {
                queryBytes.push(query.charCodeAt(i));
            }

            for (let i = 0; i <= data.length - queryBytes.length; i++) {
                let match = true;
                for (let j = 0; j < queryBytes.length; j++) {
                    if (data[i + j] !== queryBytes[j]) { match = false; break; }
                }
                if (match) results.push(i);
            }
            return results;
        }

        function filterStrings(value) {
            hexViewer.stringsFilter = value;

            const filter = value.toLowerCase();
            const filtered = filter
                ? hexViewer.extractedStrings.filter(s => s.str.toLowerCase().includes(filter))
                : hexViewer.extractedStrings;

            hexViewer.filteredStrings = filtered;

            const virtualContent = document.getElementById('stringsVirtualContent');
            if (virtualContent) {
                virtualContent.style.height = (filtered.length * 28) + 'px';
            }

            const scrollContainer = document.getElementById('stringsScrollContainer');
            if (scrollContainer) {
                scrollContainer.scrollTop = 0;
            }

            const countEl = document.querySelector('.strings-count');
            if (countEl) {
                countEl.textContent = `${filtered.length.toLocaleString()} strings${filter ? ' (filtered)' : ''}`;
            }

            renderVisibleStrings();
        }

        function searchStrings() {
            const input = document.getElementById('stringsSearchInput');
            const query = input ? input.value.toLowerCase() : '';
            hexViewer.stringsFilter = query;

            if (!query || !hexViewer.extractedStrings) {
                hexViewer.stringsMatchIndices = [];
                hexViewer.stringsCurrentMatch = 0;
                hexViewer.stringsMatchCount = 0;
                filterStrings('');
                refreshBinaryViewer();
                return;
            }

            const filtered = [];
            const matchIndices = [];
            hexViewer.extractedStrings.forEach((s, idx) => {
                if (s.str.toLowerCase().includes(query)) {
                    matchIndices.push(filtered.length);
                    filtered.push(s);
                }
            });

            hexViewer.filteredStrings = filtered;
            hexViewer.stringsMatchIndices = matchIndices;
            hexViewer.stringsMatchCount = filtered.length;
            hexViewer.stringsCurrentMatch = filtered.length > 0 ? 0 : -1;

            refreshBinaryViewer();

            if (filtered.length > 0) {
                setTimeout(() => {
                    const container = document.getElementById('stringsScrollContainer');
                    if (container) {
                        container.scrollTop = 0;
                        renderVisibleStrings();
                    }
                }, 50);
            }
        }

        function navigateStringMatch(dir) {
            if (hexViewer.stringsMatchCount === 0) return;

            hexViewer.stringsCurrentMatch += dir;
            if (hexViewer.stringsCurrentMatch < 0) {
                hexViewer.stringsCurrentMatch = hexViewer.stringsMatchCount - 1;
            } else if (hexViewer.stringsCurrentMatch >= hexViewer.stringsMatchCount) {
                hexViewer.stringsCurrentMatch = 0;
            }

            const container = document.getElementById('stringsScrollContainer');
            if (container) {
                const scrollTop = hexViewer.stringsCurrentMatch * 28 - container.clientHeight / 2 + 14;
                container.scrollTop = Math.max(0, scrollTop);
                renderVisibleStrings();
            }

            const infoEl = document.querySelector('.strings-filter-bar .hex-search-info');
            if (infoEl) {
                infoEl.textContent = `${hexViewer.stringsCurrentMatch + 1} / ${hexViewer.stringsMatchCount}`;
            }
        }

        function jumpToStringOffset(offset, searchStr) {

            hexViewer.highlightOffset = offset;
            hexViewer.highlightLength = searchStr ? searchStr.length : 16;
            hexViewer.mode = 'hex';
            refreshBinaryViewer();

            setTimeout(() => {
                const lineOffset = Math.floor(offset / 16);
                const scrollTop = Math.max(0, (lineOffset - 3) * hexViewer.lineHeight); // Show a few lines above
                const container = document.getElementById('hexScrollContainer');
                if (container) {
                    container.scrollTop = scrollTop;
                }
            }, 50);
        }

        function refreshBinaryViewer() {
            const viewer = document.getElementById('fileViewer');
            const filePath = document.getElementById('currentFilePath').textContent;
            renderBinaryViewer(viewer, { type: 'binary', data: hexViewer.data, size: hexViewer.size, header: { format: 'Binary', details: [`${formatSize(hexViewer.size)}`] } }, filePath);
        }

        function exportReport() {
            const results = state.analysisResults;
            if (!results) return;

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 15;
                const contentWidth = pageWidth - (margin * 2);
                let y = margin;

                const colors = {
                    primary: [99, 102, 241],
                    high: [220, 38, 38],
                    warning: [217, 119, 6],
                    info: [8, 145, 178],
                    secure: [22, 163, 74],
                    dark: [17, 24, 39],
                    text: [31, 41, 55],
                    muted: [107, 114, 128],
                    lightBg: [248, 250, 252],
                    noteBg: [254, 249, 195]
                };

                function checkPageBreak(needed = 15) {
                    if (y + needed > pageHeight - 18) {
                        doc.addPage();
                        y = margin;
                        return true;
                    }
                    return false;
                }

                function drawSectionHeader(title) {
                    checkPageBreak(14);
                    doc.setFillColor(...colors.primary);
                    doc.roundedRect(margin, y, contentWidth, 8, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.text(title, margin + 4, y + 5.5);
                    y += 12;
                    doc.setTextColor(...colors.text);
                    doc.setFont('helvetica', 'normal');
                }

                function drawSubHeader(title) {
                    checkPageBreak(10);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...colors.primary);
                    doc.text(title, margin + 2, y);
                    y += 5;
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...colors.text);
                }

                function drawRow(key, value, keyWidth = 40) {
                    checkPageBreak(6);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...colors.muted);
                    doc.text(key, margin + 2, y);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...colors.text);
                    const valStr = String(value || 'N/A');
                    const maxW = contentWidth - keyWidth - 5;
                    if (doc.getTextWidth(valStr) > maxW) {
                        const lines = doc.splitTextToSize(valStr, maxW);
                        doc.text(lines, margin + keyWidth + 2, y);
                        y += lines.length * 4;
                    } else {
                        doc.text(valStr, margin + keyWidth + 2, y);
                        y += 5;
                    }
                }

                function drawNote(text, bgColor = colors.noteBg) {
                    checkPageBreak(15);
                    doc.setFillColor(...bgColor);
                    const noteLines = doc.splitTextToSize(text, contentWidth - 10);
                    const noteHeight = noteLines.length * 3.5 + 6;
                    doc.roundedRect(margin, y, contentWidth, noteHeight, 2, 2, 'F');
                    doc.setFontSize(7);
                    doc.setTextColor(...colors.text);
                    doc.text(noteLines, margin + 5, y + 4);
                    y += noteHeight + 4;
                }

                // ===== HEADER =====
                doc.setFillColor(...colors.dark);
                doc.rect(0, 0, pageWidth, 38, 'F');
                
                // Title
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text('IPA Security Audit Report', margin, 16);
                
                // App info
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(200, 200, 210);
                doc.text(results.appInfo.appName || 'Unknown App', margin, 24);
                doc.setFontSize(8);
                doc.setTextColor(160, 160, 170);
                doc.text(results.appInfo.bundleId || '', margin, 30);
                
                // Date
                doc.setFontSize(8);
                doc.setTextColor(160, 160, 170);
                doc.text('Generated: ' + new Date().toLocaleString(), pageWidth - margin, 30, { align: 'right' });

                y = 46;

                // ===== SCAN SUMMARY =====
                drawSectionHeader('Scan Summary');

                const highCount = state.groupedFindings.high.length;
                const warnCount = state.groupedFindings.warning.length;
                const infoCount = state.groupedFindings.info.length;
                const secureCount = state.groupedFindings.secure.length;
                const totalFindings = highCount + warnCount + infoCount;

                // Summary paragraph
                doc.setFontSize(9);
                doc.setTextColor(...colors.text);

                const summaryText = `Pattern-based scan of "${results.appInfo.appName || 'Unknown'}" (${results.appInfo.bundleId || 'N/A'}) found ${totalFindings} pattern matches that may indicate security issues. These findings require manual verification - see notes at end of report.`;
                const summaryLines = doc.splitTextToSize(summaryText, contentWidth - 4);
                doc.text(summaryLines, margin + 2, y);
                y += summaryLines.length * 4 + 4;

                // Findings summary boxes
                const boxWidth = (contentWidth - 12) / 4;
                const boxHeight = 18;
                const boxes = [
                    { label: 'HIGH', count: highCount, color: colors.high, desc: 'Review First' },
                    { label: 'WARNING', count: warnCount, color: colors.warning, desc: 'Check These' },
                    { label: 'INFO', count: infoCount, color: colors.info, desc: 'Low' },
                    { label: 'SECURE', count: secureCount, color: colors.secure, desc: 'Good' }
                ];

                boxes.forEach((box, i) => {
                    const bx = margin + i * (boxWidth + 4);
                    doc.setFillColor(...box.color);
                    doc.roundedRect(bx, y, boxWidth, boxHeight, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text(box.count.toString(), bx + boxWidth / 2, y + 8, { align: 'center' });
                    doc.setFontSize(6);
                    doc.setFont('helvetica', 'normal');
                    doc.text(box.label, bx + boxWidth / 2, y + 13, { align: 'center' });
                    doc.setFontSize(5);
                    doc.text(box.desc, bx + boxWidth / 2, y + 16.5, { align: 'center' });
                });
                y += boxHeight + 8;

                // Info note about manual verification
                doc.setFillColor(240, 249, 255);
                doc.roundedRect(margin, y, contentWidth, 8, 2, 2, 'F');
                doc.setTextColor(30, 64, 175);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                doc.text('Note: These are pattern matches only. Manual verification required for each finding.', margin + contentWidth / 2, y + 5, { align: 'center' });
                y += 14;

                // ===== APPLICATION INFORMATION =====
                drawSectionHeader('Application Information');
                drawRow('Bundle ID', results.appInfo.bundleId);
                drawRow('Version', results.appInfo.version);
                drawRow('Build Number', results.appInfo.build);
                drawRow('Minimum iOS', results.appInfo.minOS);
                drawRow('Executable', results.appInfo.executableName);
                drawRow('File Size', results.appInfo.fileSize);
                if (results.appInfo.sha256) {
                    drawRow('SHA-256 Hash', results.appInfo.sha256);
                }
                y += 4;

                // ===== BINARY SECURITY =====
                drawSectionHeader('Binary Security Analysis');
                
                drawNote('Binary security checks verify that the application executable has been compiled with modern security protections enabled. Missing protections can make the app more vulnerable to exploitation.', [240, 249, 255]);

                const checksecItems = [
                    { name: 'PIE (ASLR)', enabled: results.checksec.pie, desc: 'Position Independent Executable - Randomizes memory addresses' },
                    { name: 'ARC', enabled: results.checksec.arc, desc: 'Automatic Reference Counting - Prevents memory corruption' },
                    { name: 'Stack Canary', enabled: results.checksec.canary, desc: 'Buffer overflow protection' },
                    { name: '64-bit Binary', enabled: results.checksec.is64bit, desc: 'Modern architecture with enhanced security' }
                ];

                checksecItems.forEach((item) => {
                    checkPageBreak(7);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...colors.text);
                    doc.text(item.name, margin + 2, y);
                    
                    const statusColor = item.enabled ? colors.secure : colors.high;
                    doc.setFillColor(...statusColor);
                    doc.roundedRect(margin + 45, y - 3, 18, 5, 1, 1, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(6);
                    doc.text(item.enabled ? 'PASS' : 'FAIL', margin + 54, y, { align: 'center' });
                    
                    doc.setTextColor(...colors.muted);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'normal');
                    doc.text(item.desc, margin + 68, y);
                    y += 6;
                });
                y += 4;

                // ===== PERMISSIONS =====
                const perms = Object.entries(results.permissions);
                if (perms.length > 0) {
                    drawSectionHeader('Requested Permissions (' + perms.length + ')');
                    
                    drawNote('These are the system permissions requested by the application. Each permission should have a legitimate use case. Review the stated reasons to ensure they align with the app\'s functionality.');
                    
                    perms.forEach(([key, val]) => {
                        checkPageBreak(14);
                        doc.setFontSize(8);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(...colors.text);
                        doc.text(' ' + val.name, margin + 2, y);
                        y += 4;

                        doc.setFontSize(6);
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(...colors.primary);
                        doc.text('Key: ' + key, margin + 6, y);
                        y += 3.5;

                        if (val.reason) {
                            doc.setTextColor(...colors.muted);
                            doc.setFontSize(6);
                            const reasonLines = doc.splitTextToSize('Reason: "' + val.reason + '"', contentWidth - 12);
                            doc.text(reasonLines, margin + 6, y);
                            y += reasonLines.length * 3;
                        }
                        y += 3;
                    });
                    y += 2;
                }

                // ===== URL SCHEMES =====
                if (results.urlSchemes && results.urlSchemes.length > 0) {
                    drawSectionHeader('URL Schemes (' + results.urlSchemes.length + ')');
                    
                    drawNote('URL schemes allow other apps to launch this application. Ensure proper input validation is implemented for any data received through URL schemes to prevent injection attacks.');
                    
                    doc.setFontSize(8);
                    doc.setTextColor(...colors.text);
                    const schemesText = results.urlSchemes.map(s => s + '://').join(', ');
                    const schemeLines = doc.splitTextToSize(schemesText, contentWidth - 4);
                    doc.text(schemeLines, margin + 2, y);
                    y += schemeLines.length * 4 + 4;
                }

                // ===== TRACKERS & SDKs =====
                if (results.trackers && results.trackers.length > 0) {
                    drawSectionHeader('Detected SDKs & Trackers (' + results.trackers.length + ')');
                    
                    drawNote('Third-party SDKs and trackers may collect user data. Review the privacy policies of these services to ensure compliance with data protection regulations.');
                    
                    doc.setFontSize(8);
                    doc.setTextColor(...colors.warning);
                    const trackerLines = doc.splitTextToSize(results.trackers.join(', '), contentWidth - 4);
                    doc.text(trackerLines, margin + 2, y);
                    y += trackerLines.length * 4 + 4;
                }

                // ===== SECURITY FINDINGS =====
                doc.addPage();
                y = margin;
                drawSectionHeader('Detailed Security Findings');

                const allFindings = [
                    ...state.groupedFindings.high,
                    ...state.groupedFindings.warning,
                    ...state.groupedFindings.info,
                    ...state.groupedFindings.secure
                ];

                if (allFindings.length === 0) {
                    doc.setFontSize(9);
                    doc.setTextColor(...colors.muted);
                    doc.text('No security findings detected.', margin + 2, y);
                    y += 8;
                } else {
                    // Add findings note
                    drawNote('The following findings are grouped by rule type. Each finding includes the severity, description, relevant security standards (CWE, OWASP, MASVS), and the specific locations in the code where the issue was detected.');

                    allFindings.forEach((finding, idx) => {
                        checkPageBreak(30);

                        // Finding header with severity badge
                        const sevColor = colors[finding.severity] || colors.info;
                        doc.setFillColor(...sevColor);
                        doc.roundedRect(margin, y, 20, 6, 1.5, 1.5, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(6);
                        doc.setFont('helvetica', 'bold');
                        doc.text(finding.severity.toUpperCase(), margin + 10, y + 4, { align: 'center' });

                        // Finding title
                        doc.setTextColor(...colors.text);
                        doc.setFontSize(10);
                        doc.text(finding.ruleName, margin + 24, y + 4.5);
                        y += 9;

                        // Description
                        doc.setFontSize(8);
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(...colors.text);
                        const descLines = doc.splitTextToSize(finding.description, contentWidth - 4);
                        doc.text(descLines, margin + 2, y);
                        y += descLines.length * 3.5 + 2;

                        // Security standards tags
                        const metaTags = [];
                        if (finding.cwe) {
                            const cweVal = finding.cwe.toString().replace(/^CWE-?/i, '');
                            metaTags.push('CWE-' + cweVal);
                        }
                        if (finding.owasp) {
                            const owaspVal = finding.owasp.toString().replace(/^OWASP-?/i, '');
                            metaTags.push('OWASP ' + owaspVal);
                        }
                        if (finding.masvs) {
                            const masvsVal = finding.masvs.toString().replace(/^MASVS-?/i, '');
                            metaTags.push('MASVS-' + masvsVal);
                        }
                        
                        if (metaTags.length > 0) {
                            doc.setFontSize(7);
                            doc.setTextColor(...colors.primary);
                            doc.setFont('helvetica', 'bold');
                            doc.text('Standards: ', margin + 2, y);
                            doc.setFont('helvetica', 'normal');
                            doc.text(metaTags.join('    '), margin + 22, y);
                            y += 5;
                        }

                        // Instances
                        doc.setFontSize(8);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(...colors.text);
                        doc.text(`Found in ${finding.instances.length} location${finding.instances.length > 1 ? 's' : ''}:`, margin + 2, y);
                        y += 4;

                        // Show ALL instances - no limit
                        finding.instances.forEach((inst, i) => {
                            checkPageBreak(10);
                            doc.setFontSize(7);
                            doc.setFont('helvetica', 'normal');
                            doc.setTextColor(...colors.primary);
                            
                            const fileDisplay = inst.file.startsWith('BINARY:')
                                ? inst.file.replace('BINARY:', '') + ' (Binary)' + (inst.binaryOffset ? ' @ ' + inst.binaryOffset : '')
                                : inst.file + (inst.line ? ':' + inst.line : '');
                            doc.text(`${i + 1}. ${fileDisplay}`, margin + 4, y);
                            y += 3.5;

                            if (inst.match) {
                                doc.setFillColor(...colors.lightBg);
                                const matchText = inst.match.length > 100 ? inst.match.substring(0, 100) + '...' : inst.match;
                                const matchLines = doc.splitTextToSize(matchText, contentWidth - 16);
                                const boxH = matchLines.length * 3 + 2;
                                doc.roundedRect(margin + 6, y - 0.5, contentWidth - 12, boxH, 1, 1, 'F');
                                doc.setTextColor(...colors.text);
                                doc.setFontSize(6);
                                doc.text(matchLines, margin + 8, y + 2);
                                y += boxH + 2;
                            }
                        });

                        y += 3;
                        doc.setDrawColor(220, 220, 220);
                        doc.line(margin, y, margin + contentWidth, y);
                        y += 5;
                    });
                }

                // ===== NOTES & DISCLAIMER =====
                checkPageBreak(60);
                drawSectionHeader('How This Tool Works');

                const notes = [
                    'Pattern-Based Scanning: This tool uses regular expression (grep-style) pattern matching to identify potential security issues. It searches for known vulnerable patterns, suspicious strings, and insecure configurations in the IPA contents.',
                    'NOT Code Analysis: This is NOT a code analyzer or decompiler. It extracts strings from binaries and scans text files for patterns. It cannot understand code logic, data flow, or runtime behavior.',
                    'Manual Verification Required: ALL findings must be manually verified. Pattern matching produces false positives - a matched pattern may not be a real vulnerability in your specific context.',
                    'Static Analysis Only: This tool only examines the IPA file contents at rest. It does not perform dynamic analysis, runtime testing, network interception, or server-side security assessment.',
                    'Severity Levels: HIGH = pattern strongly suggests a security issue. WARNING = pattern may indicate a problem. INFO = informational finding. SECURE = detected good security practice. These are based on pattern matching, not actual risk assessment.',
                    'Binary String Extraction: Binary analysis works by extracting printable ASCII strings from the Mach-O executable. Many strings may be from system frameworks, not your actual code.',
                    'Limitations: Obfuscated code, encrypted content, assets in non-standard formats, and runtime-loaded content cannot be analyzed. Swift/ObjC code logic is not analyzed.',
                    'Privacy: All processing happens in your browser. No files are uploaded to any server. The IPA never leaves your device.'
                ];

                notes.forEach((note, i) => {
                    checkPageBreak(12);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...colors.text);
                    const noteLines = doc.splitTextToSize(`${i + 1}. ${note}`, contentWidth - 8);
                    doc.text(noteLines, margin + 4, y);
                    y += noteLines.length * 3 + 3;
                });

                y += 5;
                
                // Final disclaimer box
                doc.setFillColor(254, 243, 199);
                const disclaimerText = 'IMPORTANT: This is an automated pattern-matching scanner, NOT a security audit tool. Results are indicative only and require manual verification by a qualified security professional. Many findings may be false positives. Do not rely solely on this report for security decisions.';
                const disclaimerLines = doc.splitTextToSize(disclaimerText, contentWidth - 10);
                const disclaimerHeight = disclaimerLines.length * 3.5 + 6;
                doc.roundedRect(margin, y, contentWidth, disclaimerHeight, 2, 2, 'F');
                doc.setFontSize(7);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(146, 64, 14);
                doc.text(disclaimerLines, margin + 5, y + 4);
                y += disclaimerHeight + 4;

                // ===== PAGE NUMBERS & FOOTER =====
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(7);
                    doc.setTextColor(...colors.muted);
                    doc.text('IPA Auditor - https://ipaauditor.com', margin, pageHeight - 6);
                    doc.text(`Page ${i} of ${pageCount}`, pageWidth - margin, pageHeight - 6, { align: 'right' });
                    
                    // Add thin line above footer
                    doc.setDrawColor(220, 220, 220);
                    doc.line(margin, pageHeight - 10, pageWidth - margin, pageHeight - 10);
                }

                const fileName = `IPA-Security-Audit-${(results.appInfo.bundleId || 'report').replace(/[^a-zA-Z0-9-]/g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                showToast('PDF report exported successfully!', 'success');

            } catch (error) {
                console.error('PDF export failed:', error);
                showToast('PDF export failed: ' + error.message, 'error');
            }
        }

        function escapeHtml(text) {
            if (text == null) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }

        function escapeAttr(text) {
            if (text == null) return '';
            return String(text)
                .replace(/&/g, '&amp;')
                .replace(/'/g, '&#39;')
                .replace(/"/g, '&quot;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\\/g, '\\\\')
                .replace(/\n/g, '\\n')
                .replace(/\r/g, '\\r');
        }

        function escapeJs(text) {
            if (text == null) return '';
            return String(text)
                .replace(/\\/g, '\\\\')
                .replace(/'/g, "\\'")
                .replace(/"/g, '\\"')
                .replace(/\n/g, '\\n')
                .replace(/\r/g, '\\r')
                .replace(/</g, '\\x3c')
                .replace(/>/g, '\\x3e');
        }

        function formatSize(bytes) {
            const units = ['B', 'KB', 'MB', 'GB'];
            let i = 0;
            while (bytes >= 1024 && i < units.length - 1) { bytes /= 1024; i++; }
            return bytes.toFixed(1) + ' ' + units[i];
        }
    </script>
</body>
</html>